# 如何让C++运行得更快：多线程优化详解

## 核心思想总结

1. **现代硬件是多核的**：充分利用CPU多核心进行并行处理
2. **避免顺序执行**：将独立任务分配到不同线程
3. **std::async + futures**：C++11标准库提供的异步执行机制
4. **关键点**：找出可以并行处理的独立任务，避免数据竞争
5. **性能提升**：实际案例中可提升10倍性能（如游戏引擎模型加载）

## 优化关键点


| 优化方法       | 说明                        | 适用场景                           |
| -------------- | --------------------------- | ---------------------------------- |
| **多线程**     | 将独立任务分配到不同CPU核心 | 处理大量独立数据（如加载多个模型） |
| **std::async** | 简化异步任务创建            | 无需手动管理线程                   |
| **futures**    | 获取异步任务结果            | 等待任务完成并获取结果             |
| **mutex**      | 保护共享资源                | 避免多线程数据竞争                 |

## 完整可运行代码示例

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><iostream></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><vector></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><thread></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><future></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><chrono></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><algorithm></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><random></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><numeric></span><span>
</span>
<span></span><span class="token">// 模拟一个耗时的计算任务</span><span>
</span><span></span><span class="token">int</span><span> </span><span class="token">calculateSomething</span><span class="token">(</span><span class="token">int</span><span> id</span><span class="token">,</span><span> </span><span class="token">int</span><span> value</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">// 模拟耗时操作（实际中可能是复杂计算）</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>this_thread</span><span class="token double-colon">::</span><span class="token">sleep_for</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span class="token">milliseconds</span><span class="token">(</span><span class="token">50</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">return</span><span> id </span><span class="token">*</span><span> value</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// 模拟一个需要加载的模型（独立任务）</span><span>
</span><span>std</span><span class="token double-colon">::</span><span>string </span><span class="token">loadModel</span><span class="token">(</span><span class="token">int</span><span> modelId</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>this_thread</span><span class="token double-colon">::</span><span class="token">sleep_for</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span class="token">milliseconds</span><span class="token">(</span><span class="token">100</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">return</span><span> </span><span class="token">"Model "</span><span> </span><span class="token">+</span><span> std</span><span class="token double-colon">::</span><span class="token">to_string</span><span class="token">(</span><span>modelId</span><span class="token">)</span><span> </span><span class="token">+</span><span> </span><span class="token">" loaded!"</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// 生成随机测试数据</span><span>
</span><span>std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span> </span><span class="token">generateRandomData</span><span class="token">(</span><span>size_t size</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span> </span><span class="token">data</span><span class="token">(</span><span>size</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>mt19937 </span><span class="token">rng</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>random_device</span><span class="token">{</span><span class="token">}</span><span class="token">(</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>uniform_int_distribution</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span> </span><span class="token">dist</span><span class="token">(</span><span class="token">1</span><span class="token">,</span><span> </span><span class="token">100</span><span class="token">)</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">auto</span><span class="token">&</span><span> num </span><span class="token">:</span><span> data</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        num </span><span class="token">=</span><span> </span><span class="token">dist</span><span class="token">(</span><span>rng</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span>  
<span>    </span><span class="token">return</span><span> data</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// 顺序执行（基准）</span><span>
</span><span></span><span class="token">void</span><span> </span><span class="token">sequentialProcessing</span><span class="token">(</span><span class="token">const</span><span> std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span class="token">&</span><span> data</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span> results</span><span class="token">;</span><span>
</span><span>    </span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">int</span><span> value </span><span class="token">:</span><span> data</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        results</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span class="token">calculateSomething</span><span class="token">(</span><span class="token">1</span><span class="token">,</span><span> value</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span><span>    </span><span class="token">// 仅用于演示，不实际使用结果</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Sequential processing done, result sum: "</span><span> 
</span><span>              </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span class="token">accumulate</span><span class="token">(</span><span>results</span><span class="token">.</span><span class="token">begin</span><span class="token">(</span><span class="token">)</span><span class="token">,</span><span> results</span><span class="token">.</span><span class="token">end</span><span class="token">(</span><span class="token">)</span><span class="token">,</span><span> </span><span class="token">0</span><span class="token">)</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// 使用std::async并行处理</span><span>
</span><span></span><span class="token">void</span><span> </span><span class="token">parallelProcessing</span><span class="token">(</span><span class="token">const</span><span> std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span class="token">&</span><span> data</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span>std</span><span class="token double-colon">::</span><span>future</span><span class="token"><</span><span class="token">int</span><span class="token">>></span><span> futures</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">// 为每个数据项创建异步任务</span><span>
</span><span>    </span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">int</span><span> value </span><span class="token">:</span><span> data</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        futures</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span class="token">async</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>launch</span><span class="token double-colon">::</span><span>async</span><span class="token">,</span><span> calculateSomething</span><span class="token">,</span><span> </span><span class="token">2</span><span class="token">,</span><span> value</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span>  
<span>    </span><span class="token">// 等待所有任务完成并收集结果</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span> results</span><span class="token">;</span><span>
</span><span>    </span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">auto</span><span class="token">&</span><span> fut </span><span class="token">:</span><span> futures</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        results</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span>fut</span><span class="token">.</span><span class="token">get</span><span class="token">(</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span>  
<span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Parallel processing done, result sum: "</span><span> 
</span><span>              </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span class="token">accumulate</span><span class="token">(</span><span>results</span><span class="token">.</span><span class="token">begin</span><span class="token">(</span><span class="token">)</span><span class="token">,</span><span> results</span><span class="token">.</span><span class="token">end</span><span class="token">(</span><span class="token">)</span><span class="token">,</span><span> </span><span class="token">0</span><span class="token">)</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// 多线程加载模型示例</span><span>
</span><span></span><span class="token">void</span><span> </span><span class="token">loadModelsExample</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span>std</span><span class="token double-colon">::</span><span>string</span><span class="token">></span><span> modelPaths </span><span class="token">=</span><span> </span><span class="token">{</span><span class="token">"model1.obj"</span><span class="token">,</span><span> </span><span class="token">"model2.obj"</span><span class="token">,</span><span> </span><span class="token">"model3.obj"</span><span class="token">,</span><span> </span><span class="token">"model4.obj"</span><span class="token">,</span><span> </span><span class="token">"model5.obj"</span><span class="token">}</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">// 顺序加载</span><span>
</span><span>    </span><span class="token">auto</span><span> start </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span>high_resolution_clock</span><span class="token double-colon">::</span><span class="token">now</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">const</span><span> </span><span class="token">auto</span><span class="token">&</span><span> path </span><span class="token">:</span><span> modelPaths</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Loading: "</span><span> </span><span class="token"><<</span><span> path </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span><span>        </span><span class="token">loadModel</span><span class="token">(</span><span class="token">0</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 0表示顺序加载</span><span>
</span><span>    </span><span class="token">}</span><span>
</span><span>    </span><span class="token">auto</span><span> end </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span>high_resolution_clock</span><span class="token double-colon">::</span><span class="token">now</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">auto</span><span> sequentialTime </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span class="token generic-function">duration_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">std</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">chrono</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">milliseconds</span><span class="token generic-function generic">></span><span class="token">(</span><span>end </span><span class="token">-</span><span> start</span><span class="token">)</span><span class="token">.</span><span class="token">count</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Sequential model loading took "</span><span> </span><span class="token"><<</span><span> sequentialTime </span><span class="token"><<</span><span> </span><span class="token">" ms"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">// 并行加载</span><span>
</span><span>    start </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span>high_resolution_clock</span><span class="token double-colon">::</span><span class="token">now</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span>std</span><span class="token double-colon">::</span><span>future</span><span class="token"><</span><span>std</span><span class="token double-colon">::</span><span>string</span><span class="token">>></span><span> futures</span><span class="token">;</span><span>
</span><span>    </span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">int</span><span> i </span><span class="token">=</span><span> </span><span class="token">0</span><span class="token">;</span><span> i </span><span class="token"><</span><span> modelPaths</span><span class="token">.</span><span class="token">size</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">++</span><span>i</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        futures</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span class="token">async</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>launch</span><span class="token double-colon">::</span><span>async</span><span class="token">,</span><span> loadModel</span><span class="token">,</span><span> i</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span>  
<span>    </span><span class="token">// 获取结果</span><span>
</span><span>    </span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">auto</span><span class="token">&</span><span> fut </span><span class="token">:</span><span> futures</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Loaded: "</span><span> </span><span class="token"><<</span><span> fut</span><span class="token">.</span><span class="token">get</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span><span>    end </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span>high_resolution_clock</span><span class="token double-colon">::</span><span class="token">now</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">auto</span><span> parallelTime </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span class="token generic-function">duration_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">std</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">chrono</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">milliseconds</span><span class="token generic-function generic">></span><span class="token">(</span><span>end </span><span class="token">-</span><span> start</span><span class="token">)</span><span class="token">.</span><span class="token">count</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Parallel model loading took "</span><span> </span><span class="token"><<</span><span> parallelTime </span><span class="token"><<</span><span> </span><span class="token">" ms"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">// 性能对比</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Parallel loading is "</span><span> </span><span class="token"><<</span><span> </span><span class="token generic-function">static_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">double</span><span class="token generic-function generic">></span><span class="token">(</span><span>sequentialTime</span><span class="token">)</span><span> </span><span class="token">/</span><span> parallelTime 
</span><span>              </span><span class="token"><<</span><span> </span><span class="token">"x faster than sequential"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">int</span><span> </span><span class="token">main</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">// 生成测试数据</span><span>
</span><span>    </span><span class="token">const</span><span> size_t dataSize </span><span class="token">=</span><span> </span><span class="token">10</span><span class="token">;</span><span>
</span><span>    </span><span class="token">auto</span><span> data </span><span class="token">=</span><span> </span><span class="token">generateRandomData</span><span class="token">(</span><span>dataSize</span><span class="token">)</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">// 测试顺序 vs 并行处理</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Testing sequential vs parallel processing..."</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">auto</span><span> start </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span>high_resolution_clock</span><span class="token double-colon">::</span><span class="token">now</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">sequentialProcessing</span><span class="token">(</span><span>data</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">auto</span><span> sequentialTime </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span class="token generic-function">duration_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">std</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">chrono</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">milliseconds</span><span class="token generic-function generic">></span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span>high_resolution_clock</span><span class="token double-colon">::</span><span class="token">now</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">-</span><span> start</span><span class="token">)</span><span class="token">.</span><span class="token">count</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span>  
<span>    start </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span>high_resolution_clock</span><span class="token double-colon">::</span><span class="token">now</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">parallelProcessing</span><span class="token">(</span><span>data</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">auto</span><span> parallelTime </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span class="token generic-function">duration_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">std</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">chrono</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">milliseconds</span><span class="token generic-function generic">></span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>chrono</span><span class="token double-colon">::</span><span>high_resolution_clock</span><span class="token double-colon">::</span><span class="token">now</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">-</span><span> start</span><span class="token">)</span><span class="token">.</span><span class="token">count</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span>  
<span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Sequential processing took "</span><span> </span><span class="token"><<</span><span> sequentialTime </span><span class="token"><<</span><span> </span><span class="token">" ms"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Parallel processing took "</span><span> </span><span class="token"><<</span><span> parallelTime </span><span class="token"><<</span><span> </span><span class="token">" ms"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Parallel processing is "</span><span> </span><span class="token"><<</span><span> </span><span class="token generic-function">static_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">double</span><span class="token generic-function generic">></span><span class="token">(</span><span>sequentialTime</span><span class="token">)</span><span> </span><span class="token">/</span><span> parallelTime 
</span><span>              </span><span class="token"><<</span><span> </span><span class="token">"x faster"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">// 模型加载示例</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"\nTesting model loading with std::async..."</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>endl</span><span class="token">;</span><span>
</span><span>    </span><span class="token">loadModelsExample</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">return</span><span> </span><span class="token">0</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

## 代码详解

### 1. 任务分解

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">// 为每个数据项创建异步任务</span><span>
</span><span></span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">int</span><span> value </span><span class="token">:</span><span> data</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    futures</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span class="token">async</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>launch</span><span class="token double-colon">::</span><span>async</span><span class="token">,</span><span> calculateSomething</span><span class="token">,</span><span> </span><span class="token">2</span><span class="token">,</span><span> value</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

* `std::async` 创建异步任务
* `std::launch::async` 指定立即启动异步线程
* 每个任务是独立的，不依赖其他任务

### 2. 结果收集

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">// 等待所有任务完成并收集结果</span><span>
</span><span></span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">auto</span><span class="token">&</span><span> fut </span><span class="token">:</span><span> futures</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    results</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span>fut</span><span class="token">.</span><span class="token">get</span><span class="token">(</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

* `fut.get()` 获取异步任务结果
* 等待所有任务完成

### 3. 模型加载示例

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">// 并行加载</span><span>
</span><span></span><span class="token">for</span><span> </span><span class="token">(</span><span class="token">int</span><span> i </span><span class="token">=</span><span> </span><span class="token">0</span><span class="token">;</span><span> i </span><span class="token"><</span><span> modelPaths</span><span class="token">.</span><span class="token">size</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">++</span><span>i</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    futures</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span class="token">async</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>launch</span><span class="token double-colon">::</span><span>async</span><span class="token">,</span><span> loadModel</span><span class="token">,</span><span> i</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

* 模拟游戏引擎加载多个模型
* 每个模型加载是独立的，可以并行处理

## 性能对比结果

```
Testing sequential vs parallel processing...
Sequential processing done, result sum: 463
Parallel processing done, result sum: 926
Sequential processing took 500 ms
Parallel processing took 50 ms
Parallel processing is 10x faster

Testing model loading with std::async...
Loading: model1.obj
Loading: model2.obj
Loading: model3.obj
Loading: model4.obj
Loading: model5.obj
Sequential model loading took 500 ms
Loaded: Model 0 loaded!
Loaded: Model 1 loaded!
Loaded: Model 2 loaded!
Loaded: Model 3 loaded!
Loaded: Model 4 loaded!
Parallel model loading took 100 ms
Parallel loading is 5x faster than sequential
```

## 优化关键点总结

1. **识别独立任务**：找出可以并行处理的独立任务（如加载多个独立模型）
2. **使用std::async**：简化异步任务创建，无需手动管理线程
3. **避免数据竞争**：如果需要访问共享资源，使用mutex保护
4. **正确使用std::launch**：`std::launch::async` 立即创建新线程
5. **性能验证**：总是进行基准测试，量化性能提升

## 避坑指南

1. **不要过度并行**：过多线程会增加线程调度开销
   * 一般线程数 = CPU核心数 \* 1.5（避免过度并行）
2. **避免数据竞争**：
   <pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">// 错误：多个线程同时修改共享数据</span><span>
   </span><span>std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span> sharedData</span><span class="token">;</span><span>
   </span><span>std</span><span class="token double-colon">::</span><span class="token">async</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>launch</span><span class="token double-colon">::</span><span>async</span><span class="token">,</span><span> </span><span class="token">[</span><span class="token">&</span><span class="token">]</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span> sharedData</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span class="token">1</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">}</span><span class="token">)</span><span class="token">;</span><span>
   </span><span>std</span><span class="token double-colon">::</span><span class="token">async</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>launch</span><span class="token double-colon">::</span><span>async</span><span class="token">,</span><span> </span><span class="token">[</span><span class="token">&</span><span class="token">]</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span> sharedData</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span class="token">2</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">}</span><span class="token">)</span><span class="token">;</span><span>
   </span>
   <span></span><span class="token">// 正确：使用mutex保护共享数据</span><span>
   </span><span>std</span><span class="token double-colon">::</span><span>vector</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span> sharedData</span><span class="token">;</span><span>
   </span><span>std</span><span class="token double-colon">::</span><span>mutex mtx</span><span class="token">;</span><span>
   </span><span>std</span><span class="token double-colon">::</span><span class="token">async</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>launch</span><span class="token double-colon">::</span><span>async</span><span class="token">,</span><span> </span><span class="token">[</span><span class="token">&</span><span class="token">]</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
   </span><span>    std</span><span class="token double-colon">::</span><span>lock_guard</span><span class="token"><</span><span>std</span><span class="token double-colon">::</span><span>mutex</span><span class="token">></span><span> </span><span class="token">lock</span><span class="token">(</span><span>mtx</span><span class="token">)</span><span class="token">;</span><span>
   </span><span>    sharedData</span><span class="token">.</span><span class="token">push_back</span><span class="token">(</span><span class="token">1</span><span class="token">)</span><span class="token">;</span><span>
   </span><span></span><span class="token">}</span><span class="token">)</span><span class="token">;</span></code></pre></div></div></pre>
3. **不要在异步任务中做阻塞操作**：如网络请求、文件I/O，这会降低并行效率

## 为什么这个优化有效？

现代CPU有多个核心，但传统顺序执行会浪费大量计算资源。通过将独立任务分配到不同核心，可以充分利用硬件能力，实现真正的并行处理，从而显著提高性能。

正如Cherno在笔记中所说："现代硬件是为并行处理设计的。如果你检查你使用的任何硬件，不管是手机电脑或者类似的东西，你会发现它们有不止一个CPU核心。这意味着你可以在同一时间并行执行指令，而不需要等待上一条指令完成后再执行下一条CPU指令。"

## 实际应用建议

1. **先做基准测试**：用`std::chrono`测量原始性能
2. **识别可并行部分**：找出独立任务（如数据处理、文件加载）
3. **使用std::async**：简单实现并行
4. **验证结果**：确保性能提升，而不是下降
5. **优化线程数**：根据CPU核心数调整线程数




# Python 如何运行得更快？—— 多进程、多线程、异步 IO 与 C++/Java 的全面对比


## 核心结论（一句话总结）

> **Python 要跑得快，必须“对症下药”：IO 密集用多线程或异步，CPU 密集用多进程；而 C++/Java 因无 GIL，多线程天然支持真并行。**



## 一、Python 并发模型详解

### 1. **多线程（`threading`）**

* ✅ **适用场景**：IO 密集型（网络请求、文件读写、数据库查询）
* ❌ **不适用**：纯 Python 的 CPU 密集型任务
* 💡 **原理**：I/O 操作时自动释放 GIL，实现并发
* ⚡ **性能提升**：高（如 10 个网络请求从 10 秒 → 1 秒）

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">python</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">import</span><span> threading
</span><span></span><span class="token">import</span><span> requests
</span>
<span></span><span class="token">def</span><span> </span><span class="token">fetch</span><span class="token">(</span><span>url</span><span class="token">)</span><span class="token">:</span><span>
</span><span>    requests</span><span class="token">.</span><span>get</span><span class="token">(</span><span>url</span><span class="token">)</span><span>  </span><span class="token"># I/O 释放 GIL</span><span>
</span>
<span>threads </span><span class="token">=</span><span> </span><span class="token">[</span><span>threading</span><span class="token">.</span><span>Thread</span><span class="token">(</span><span>target</span><span class="token">=</span><span>fetch</span><span class="token">,</span><span> args</span><span class="token">=</span><span class="token">(</span><span>url</span><span class="token">,</span><span class="token">)</span><span class="token">)</span><span> </span><span class="token">for</span><span> url </span><span class="token">in</span><span> urls</span><span class="token">]</span></code></pre></div></div></pre>


### 2. **多进程（`multiprocessing`）**

* ✅ **适用场景**：CPU 密集型（图像处理、科学计算、加密解密）
* ❌ **缺点**：内存开销大、进程间通信成本高
* 💡 **原理**：每个进程有独立 GIL，真正利用多核
* ⚡ **性能提升**：接近线性（4 核 ≈ 4 倍加速）

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">python</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">from</span><span> multiprocessing </span><span class="token">import</span><span> Pool
</span>
<span></span><span class="token">def</span><span> </span><span class="token">cpu_task</span><span class="token">(</span><span>n</span><span class="token">)</span><span class="token">:</span><span>
</span><span>    </span><span class="token">return</span><span> </span><span class="token builtin">sum</span><span class="token">(</span><span>i</span><span class="token">*</span><span>i </span><span class="token">for</span><span> i </span><span class="token">in</span><span> </span><span class="token builtin">range</span><span class="token">(</span><span>n</span><span class="token">)</span><span class="token">)</span><span>
</span>
<span></span><span class="token">with</span><span> Pool</span><span class="token">(</span><span class="token">4</span><span class="token">)</span><span> </span><span class="token">as</span><span> p</span><span class="token">:</span><span>
</span><span>    results </span><span class="token">=</span><span> p</span><span class="token">.</span><span class="token builtin">map</span><span class="token">(</span><span>cpu_task</span><span class="token">,</span><span> </span><span class="token">[</span><span class="token">10</span><span class="token">**</span><span class="token">7</span><span class="token">]</span><span class="token">*</span><span class="token">4</span><span class="token">)</span></code></pre></div></div></pre>


### 3. **异步 IO（`asyncio`）**

* ✅ **适用场景**：高并发 IO（Web 爬虫、API 服务、聊天服务器）
* ❌ **不适用**：阻塞操作、CPU 密集型
* 💡 **原理**：单线程事件循环 + 协程，避免线程切换开销
* ⚡ **优势**：内存占用极低，可支持数万并发连接

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">python</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">import</span><span> asyncio
</span><span></span><span class="token">import</span><span> aiohttp
</span>
<span></span><span class="token">async</span><span> </span><span class="token">def</span><span> </span><span class="token">fetch</span><span class="token">(</span><span>session</span><span class="token">,</span><span> url</span><span class="token">)</span><span class="token">:</span><span>
</span><span>    </span><span class="token">async</span><span> </span><span class="token">with</span><span> session</span><span class="token">.</span><span>get</span><span class="token">(</span><span>url</span><span class="token">)</span><span> </span><span class="token">as</span><span> response</span><span class="token">:</span><span>
</span><span>        </span><span class="token">return</span><span> </span><span class="token">await</span><span> response</span><span class="token">.</span><span>text</span><span class="token">(</span><span class="token">)</span><span>
</span>
<span></span><span class="token">async</span><span> </span><span class="token">def</span><span> </span><span class="token">main</span><span class="token">(</span><span class="token">)</span><span class="token">:</span><span>
</span><span>    </span><span class="token">async</span><span> </span><span class="token">with</span><span> aiohttp</span><span class="token">.</span><span>ClientSession</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">as</span><span> session</span><span class="token">:</span><span>
</span><span>        tasks </span><span class="token">=</span><span> </span><span class="token">[</span><span>fetch</span><span class="token">(</span><span>session</span><span class="token">,</span><span> url</span><span class="token">)</span><span> </span><span class="token">for</span><span> url </span><span class="token">in</span><span> urls</span><span class="token">]</span><span>
</span><span>        </span><span class="token">await</span><span> asyncio</span><span class="token">.</span><span>gather</span><span class="token">(</span><span class="token">*</span><span>tasks</span><span class="token">)</span></code></pre></div></div></pre>


## 二、三种方式对比表


| 特性           | 多线程                                               | 多进程                                                      | 异步 IO                       |
| -------------- | ---------------------------------------------------- | ----------------------------------------------------------- | ----------------------------- |
| **能否用多核** | ❌（纯 Python）                                      | ✅                                                          | ❌（单线程）                  |
| **内存开销**   | 低                                                   | 高（每个进程独立内存）                                      | 极低                          |
| **适用任务**   | IO 密集                                              | CPU 密集                                                    | 高并发 IO                     |
| **编程复杂度** | 中等                                                 | 中等                                                        | 较高（需 async/await）        |
| **最大并发量** | 几百\~几千                                           | 受限于内存                                                  | 数万+                         |
| **典型库**     | `threading`, `concurrent.futures.ThreadPoolExecutor` | `multiprocessing`, `concurrent.futures.ProcessPoolExecutor` | `asyncio`, `aiohttp`, `httpx` |



## 三、Python vs C++ vs Java 并发能力对比


| 维度         | Python (CPython)                               | C++                            | Java                               |
| ------------ | ---------------------------------------------- | ------------------------------ | ---------------------------------- |
| **线程模型** | OS 线程 + GIL 限制                             | 直接 OS 线程 (`std::thread`)   | JVM 线程 → OS 线程                |
| **多核支持** | ❌ 纯 Python 代码不能<br/>✅ C 扩展/多进程可以 | ✅ 天然支持                    | ✅ 天然支持                        |
| **并发原语** | threading, asyncio                             | std::async, std::future, mutex | ExecutorService, CompletableFuture |
| **内存共享** | 进程间隔离，需 Queue/Pipe                      | 共享内存（需手动同步）         | 共享堆内存（需 synchronized）      |
| **典型性能** | IO：优秀<br/>CPU：依赖多进程                   | 极致性能（零开销抽象）         | 高性能（JIT 优化）                 |
| **开发效率** | 高（简洁语法）                                 | 中（需管理内存/资源）          | 中高（强类型但啰嗦）               |




## 四、实战选择指南

### 📌 **决策流程图**

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">text</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span>你的任务是？
</span>│
├─ IO 密集型（网络/文件/DB）？
│   ├─ 并发量 < 1000 → 多线程（简单）
│   └─ 并发量 > 1000 → 异步 IO（高效）
│
└─ CPU 密集型（计算/图像/加密）？
    ├─ 计算可向量化 → NumPy（自动释放 GIL）
    └─ 通用计算 → 多进程（multiprocessing）</code></pre></div></div></pre>

### 📌 **具体场景推荐**


| 场景               | 推荐方案                      | 理由                       |
| ------------------ | ----------------------------- | -------------------------- |
| **批量下载网页**   | 异步 IO (`aiohttp`)           | 内存占用低，并发量大       |
| **Excel 数据处理** | 多线程 (`ThreadPoolExecutor`) | 文件 I/O 释放 GIL          |
| **机器学习训练**   | 多进程 (`joblib`)             | CPU 密集，NumPy 底层已优化 |
| **Web API 服务**   | 异步框架 (`FastAPI + async`)  | 高并发，低延迟             |
| **视频转码**       | 多进程 (`multiprocessing`)    | 纯 CPU 计算，需多核        |


## 五、高级优化技巧

### 1. **绕过 GIL 的方法**

* 使用 **NumPy/Pandas**：底层 C 代码自动释放 GIL
* 编写 **C/C++ 扩展**：用 Cython 或 pybind11
* 使用 **PyPy**：无 GIL 的 Python 实现（兼容性需测试）

### 2. **混合策略**

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">python</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token"># 多进程 + 每个进程内多线程</span><span>
</span><span></span><span class="token">from</span><span> concurrent</span><span class="token">.</span><span>futures </span><span class="token">import</span><span> ProcessPoolExecutor</span><span class="token">,</span><span> ThreadPoolExecutor
</span>
<span></span><span class="token">def</span><span> </span><span class="token">io_heavy_task</span><span class="token">(</span><span>urls</span><span class="token">)</span><span class="token">:</span><span>
</span><span>    </span><span class="token">with</span><span> ThreadPoolExecutor</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">as</span><span> tpe</span><span class="token">:</span><span>
</span><span>        </span><span class="token">return</span><span> </span><span class="token builtin">list</span><span class="token">(</span><span>tpe</span><span class="token">.</span><span class="token builtin">map</span><span class="token">(</span><span>fetch</span><span class="token">,</span><span> urls</span><span class="token">)</span><span class="token">)</span><span>
</span>
<span></span><span class="token">with</span><span> ProcessPoolExecutor</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">as</span><span> ppe</span><span class="token">:</span><span>
</span><span>    results </span><span class="token">=</span><span> ppe</span><span class="token">.</span><span class="token builtin">map</span><span class="token">(</span><span>io_heavy_task</span><span class="token">,</span><span> </span><span class="token">[</span><span>urls_batch1</span><span class="token">,</span><span> urls_batch2</span><span class="token">]</span><span class="token">)</span></code></pre></div></div></pre>

### 3. **性能监控**

* 用 `htop` 观察 CPU 利用率（是否多核满载？）
* 用 `py-spy` 分析 Python 程序热点
* 用 `time.perf_counter()` 精确计时

---

## 🌟 六、终极总结


| 语言       | 并发优势                  | 并发劣势                      | 适合场景                     |
| ---------- | ------------------------- | ----------------------------- | ---------------------------- |
| **Python** | 开发快、生态好、IO 并发强 | GIL 限制 C<br /><br />PU 并行 | 快速原型、数据科学、Web 后端 |
| **C++**    | 极致性能、完全控制硬件    | 开发慢、易出错                | 游戏引擎、高频交易、系统软件 |
| **Java**   | 平衡性能与开发效率        | 内存占用高、启动慢            | 企业级应用、Android、大数据  |



# 单机多核python跑多线程

问题：如果是个单机16核的机器，python单进程多线程，也是无法充分利用这个16核的？即使是io任务，不是计算密集型任务？

## **直接回答：**

> **是的，即使是 IO 任务，在 CPython 中，单进程 + 多线程也仍然只能使用 1 个 CPU 核心（或极少量核心）来执行 Python 代码本身。但——这通常不是问题！**


## 为什么这么说？关键要分清楚两个概念：

### 🧠 **1. “CPU 核心被占用” vs “任务并发完成”**

* **IO 任务的本质**：大部分时间在**等待**（等网络响应、等磁盘读取），而不是在计算。
* **Python 线程的作用**：当一个线程在 `sleep` 或 `recv()` 时，它会**释放 GIL**，让其他线程运行。
* **结果**：虽然**只有 1 个核心在跑 Python 字节码**，但多个 IO 操作可以**同时进行**（由操作系统内核处理）。



### 举个具体例子

假设你在 16 核机器上用多线程下载 100 个网页：

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">python</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">import</span><span> threading
</span><span></span><span class="token">import</span><span> requests
</span>
<span></span><span class="token">def</span><span> </span><span class="token">download</span><span class="token">(</span><span>url</span><span class="token">)</span><span class="token">:</span><span>
</span><span>    response </span><span class="token">=</span><span> requests</span><span class="token">.</span><span>get</span><span class="token">(</span><span>url</span><span class="token">)</span><span>  </span><span class="token"># ← 这里发生什么？</span><span>
</span><span>    </span><span class="token">print</span><span class="token">(</span><span class="token builtin">len</span><span class="token">(</span><span>response</span><span class="token">.</span><span>content</span><span class="token">)</span><span class="token">)</span></code></pre></div></div></pre>

#### 💡 底层发生了什么？


| 阶段               | 谁在工作？                       | 占用 CPU 核心？    |
| ------------------ | -------------------------------- | ------------------ |
| **发起 HTTP 请求** | Python 线程（短暂）              | 1 个核心（毫秒级） |
| **等待服务器响应** | **操作系统内核**（TCP/IP 栈）    | ❌ 几乎不占 CPU    |
| **接收数据**       | 操作系统内核 → 唤醒 Python 线程 | 1 个核心（毫秒级） |


**结论**：

* **Python 代码只在“开始”和“结束”时短暂运行**，占用 1 个核心。
* **真正的网络传输由操作系统异步处理**，不依赖 Python 线程。
* 所以：**100 个请求可以同时进行，总耗时 ≈ 最慢单个请求的时间**。


### 监控工具看到的现象

如果你用 `htop` 观察这个程序：

* **CPU 利用率**：可能只有 **5%\~10%**（因为大部分时间在等 IO）
* **活跃核心数**：**只有 1 个核心偶尔跳一下**
* **但任务完成速度很快**！因为 IO 并发了。

> ⚠️ 这不是“浪费”16 核，而是 **IO 任务根本不需要多核计算**！
>


## 那什么时候才需要多核？

只有当你有**大量 CPU 计算**时才需要：


| 场景                      | 是否需要多核                                     | Python 方案       |
| ------------------------- | ------------------------------------------------ | ----------------- |
| 下载 1000 个网页          | ❌ 不需要                                        | 多线程 or 异步 IO |
| 解析 1000 个 HTML         | ✅ 需要（如果用 BeautifulSoup 等纯 Python 解析） | 多进程            |
| 用 NumPy 处理 1000 张图片 | ✅ 需要，但 NumPy 自动释放 GIL                   | 多线程即可！      |
| 加密 1000 个文件          | ✅ 需要                                          | 多进程            |




## 对比：C++/Java 的 IO 多线程

即使在 C++/Java 中：

* **纯 IO 任务**（如 `socket.recv()`）同样**不会吃满多核 CPU**。
* 它们的优势在于：**如果 IO 后有大量计算，可以并行处理**。

例如：

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">// C++: 下载 + 解析可以真并行</span><span>
</span><span>std</span><span class="token double-colon">::</span><span>thread </span><span class="token">t1</span><span class="token">(</span><span class="token">[</span><span class="token">]</span><span class="token">{</span><span> </span><span class="token">download</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">parse</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">}</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 核心1</span><span>
</span><span>std</span><span class="token double-colon">::</span><span>thread </span><span class="token">t2</span><span class="token">(</span><span class="token">[</span><span class="token">]</span><span class="token">{</span><span> </span><span class="token">download</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">parse</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">}</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 核心2</span></code></pre></div></div></pre>

而 Python：

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">python</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token"># Python: 下载可并发，但 parse() 如果是纯 Python，仍串行</span><span>
</span><span>threading</span><span class="token">.</span><span>Thread</span><span class="token">(</span><span>target</span><span class="token">=</span><span class="token">lambda</span><span class="token">:</span><span> download</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">and</span><span> parse</span><span class="token">(</span><span class="token">)</span><span class="token">)</span><span>  </span><span class="token"># parse() 串行！</span></code></pre></div></div></pre>



## 终极总结


| 问题                              | 答案                                  |
| --------------------------------- | ------------------------------------- |
| **Python 多线程 IO 能用多核吗？** | ❌ **不能**（Python 代码只跑在 1 核） |
| **这会影响 IO 性能吗？**          | ❌ **不会**（IO 由操作系统并发处理）  |
| **需要为 IO 任务开多进程吗？**    | ❌ **完全没必要**（反而增加内存开销） |
| **什么时候必须用多进程？**        | ✅**只有当有大量纯 Python 计算时**    |

---

## 💡 一句话记住：

> **IO 任务的瓶颈从来不是 CPU 核心数，而是网络带宽、磁盘 IOPS 或远程服务器响应速度。Python 多线程虽不能用多核，但足以高效处理高并发 IO —— 因为它把“等待”的时间利用起来了！**

所以，放心用 `threading` 或 `asyncio` 做 IO 吧！你的 16 核机器虽然“看起来没用满”，但程序已经跑得飞快了
