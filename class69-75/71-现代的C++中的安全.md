## 一、什么是“现代C++中的安全”？

在 Cherno 的观点中，**C++ 安全主要指内存安全**——即避免以下问题：

* **内存泄漏**（忘记 `delete`）
* **悬空指针 / 野指针**（访问已释放内存）
* **双重释放**（多次 `delete` 同一块内存）
* **所有权不明确**（谁该负责释放？）

> 📌 注意：这里的“安全”**不是指异常安全或类型安全**，而是聚焦于 **堆内存管理的安全性**。

## 二、为什么原始指针（raw pointer）不安全？

### 问题根源：

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">int</span><span class="token">*</span><span> p </span><span class="token">=</span><span> </span><span class="token">new</span><span> </span><span class="token">int</span><span class="token">(</span><span class="token">42</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">// ... 函数调用、异常、提前 return ...</span><span>
</span><span></span><span class="token">// 忘记 delete p → 内存泄漏！</span></code></pre></div></div></pre>

#### 典型风险：

1. **程序员必须手动管理生命周期** → 容易出错。
2. **所有权模糊**：多个函数/对象持有同一指针，谁负责 `delete`？
3. **异常不安全**：若中间抛出异常，`delete` 可能永远不会执行。

> 💬 Cherno 强调：“细心一点”不是解决方案。人类会犯错，系统应通过设计防止错误。

## 三、现代C++的解决方案：智能指针（Smart Pointers）

C++11 引入了 **RAII（Resource Acquisition Is Initialization）** 思想，通过 **智能指针自动管理内存**，实现“**零手动 delete**”。


| 智能指针          | 所有权模型                       | 线程安全                 | 适用场景         |
| ----------------- | -------------------------------- | ------------------------ | ---------------- |
| `std::unique_ptr` | 独占所有权                       | 否                       | 默认选择，高效   |
| `std::shared_ptr` | 共享所有权（引用计数）           | 部分（引用计数原子操作） | 多个对象共享资源 |
| `std::weak_ptr`   | 观察`shared_ptr`，不增加引用计数 | —                       | 解决循环引用     |

> ✅ 核心优势：**对象析构时自动释放内存**，无需手动 `delete`。

## 四、实际场景与案例对比

### 场景1：函数返回堆对象（传统 vs 现代）

#### ❌ 不安全（原始指针）

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">int</span><span class="token">*</span><span> </span><span class="token">createValue</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">return</span><span> </span><span class="token">new</span><span> </span><span class="token">int</span><span class="token">(</span><span class="token">100</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 谁 delete？调用者容易忘记！</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">void</span><span> </span><span class="token">badExample</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">int</span><span class="token">*</span><span> p </span><span class="token">=</span><span> </span><span class="token">createValue</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">// ... 使用 p</span><span>
</span><span>    </span><span class="token">// 忘记 delete → 内存泄漏</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

#### ✅ 安全（`unique_ptr`）

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><memory></span><span>
</span>
<span>std</span><span class="token double-colon">::</span><span>unique_ptr</span><span class="token"><</span><span class="token">int</span><span class="token">></span><span> </span><span class="token">createValue</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">return</span><span> std</span><span class="token double-colon">::</span><span class="token generic-function">make_unique</span><span class="token generic-function generic"><</span><span class="token generic-function generic">int</span><span class="token generic-function generic">></span><span class="token">(</span><span class="token">100</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 自动管理</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">void</span><span> </span><span class="token">goodExample</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">auto</span><span> p </span><span class="token">=</span><span> </span><span class="token">createValue</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// RAII：离开作用域自动释放</span><span>
</span><span>    </span><span class="token">// 无需 delete！</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

---

### 场景2：类成员持有动态资源

#### ❌ 不安全（原始指针 + 手动管理）

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">class</span><span> </span><span class="token">BadBuffer</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">char</span><span class="token">*</span><span> data</span><span class="token">;</span><span>
</span><span></span><span class="token">public</span><span class="token">:</span><span>
</span><span>    </span><span class="token">BadBuffer</span><span class="token">(</span><span>size_t n</span><span class="token">)</span><span> </span><span class="token">{</span><span> data </span><span class="token">=</span><span> </span><span class="token">new</span><span> </span><span class="token">char</span><span class="token">[</span><span>n</span><span class="token">]</span><span class="token">;</span><span> </span><span class="token">}</span><span>
</span><span>    </span><span class="token">~</span><span class="token">BadBuffer</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span> </span><span class="token">delete</span><span class="token">[</span><span class="token">]</span><span> data</span><span class="token">;</span><span> </span><span class="token">}</span><span>
</span><span>    </span><span class="token">// 若未定义拷贝构造/赋值 → 浅拷贝导致双重释放！</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span></code></pre></div></div></pre>

#### ✅ 安全（`unique_ptr` + RAII）

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">class</span><span> </span><span class="token">GoodBuffer</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>unique_ptr</span><span class="token"><</span><span class="token">char</span><span class="token">[</span><span class="token">]</span><span class="token">></span><span> data</span><span class="token">;</span><span>
</span><span></span><span class="token">public</span><span class="token">:</span><span>
</span><span>    </span><span class="token">GoodBuffer</span><span class="token">(</span><span>size_t n</span><span class="token">)</span><span> </span><span class="token">:</span><span> </span><span class="token">data</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span class="token generic-function">make_unique</span><span class="token generic-function generic"><</span><span class="token generic-function generic">char</span><span class="token generic-function generic">[</span><span class="token generic-function generic">]</span><span class="token generic-function generic">></span><span class="token">(</span><span>n</span><span class="token">)</span><span class="token">)</span><span> </span><span class="token">{</span><span class="token">}</span><span>
</span><span>    </span><span class="token">// 析构、移动语义自动生成，拷贝被禁用（除非显式定义）</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span></code></pre></div></div></pre>

> ✨ 编译器自动生成正确的析构、移动操作，杜绝内存错误。

### 场景3：多对象共享资源（如游戏中的纹理）

#### ✅ 使用 `shared_ptr`

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">auto</span><span> texture </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span class="token generic-function">make_shared</span><span class="token generic-function generic"><</span><span class="token generic-function generic">Texture</span><span class="token generic-function generic">></span><span class="token">(</span><span class="token">"player.png"</span><span class="token">)</span><span class="token">;</span><span>
</span>
<span>Player </span><span class="token">player</span><span class="token">(</span><span>texture</span><span class="token">)</span><span class="token">;</span><span>
</span><span>Enemy </span><span class="token">enemy</span><span class="token">(</span><span>texture</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 共享同一纹理</span><span>
</span>
<span></span><span class="token">// 当 player 和 enemy 都销毁后，texture 自动释放</span></code></pre></div></div></pre>

> ⚠️ 注意：避免循环引用（A 持有 B，B 持有 A），此时用 `weak_ptr` 打破循环。



## 五、为什么还要学原始指针？

Cherno 明确指出：

> “**初学者必须学习原始指针和内存模型**，因为智能指针只是原始指针的封装。”

* 理解 `new`/`delete`、堆栈区别、内存布局是基础。
* 调试内存问题时，需知道底层发生了什么。
* 某些高性能/嵌入式场景仍需裸指针（但应封装在 RAII 类中）。

✅ **教学建议**：

1. 先教原始指针（理解机制）
2. 尽快过渡到智能指针（实践安全）
3. 在生产代码中 **默认使用智能指针**



## 六、总结：现代C++安全的核心原则


| 原则                               | 说明                                         |
| ---------------------------------- | -------------------------------------------- |
| **避免裸 `new`/`delete`**          | 用`make_unique` / `make_shared`              |
| **明确所有权**                     | `unique_ptr` 表示独占，`shared_ptr` 表示共享 |
| **RAII 是基石**                    | 资源绑定到对象生命周期                       |
| **异常安全**                       | 智能指针在异常发生时仍能正确释放             |
| **生产代码禁用原始指针管理堆内存** | 除非必要（如对接 C API）                     |

---

## 七、一句话结论（Cherno 的观点）

> “在真实项目中拒绝使用智能指针是愚蠢的。安全不是‘可选项’，而是现代C++的基本要求。”

---

✅ **附：安全编码 checklist**

* [ ]  是否所有 `new` 都被 `make_unique`/`make_shared` 替代？
* [ ]  类是否遵循“Rule of Zero”（不写析构/拷贝，靠 RAII 成员自动管理）？
* [ ]  是否避免了裸指针作为拥有者（owning raw pointer）？
* [ ]  循环引用是否用 `weak_ptr` 解决？

# RAII


RAII 是 **“Resource Acquisition Is Initialization”** 的缩写，中文常译为：

> **“资源获取即初始化”**

这是 C++ 中一个**极其核心且强大的编程范式**，也是现代 C++ 实现**异常安全、自动资源管理（包括内存安全）的基石**。


### 一、RAII 的核心思想

> **把资源（如内存、文件句柄、锁、网络连接等）的生命周期绑定到一个对象的生命周期上。**
>
> * 资源在**对象构造时获取**（Acquisition during Initialization）
> * 资源在**对象析构时自动释放**（Release in Destructor）

由于 C++ 保证：**局部对象离开作用域时，其析构函数一定会被调用**（即使发生异常！），因此资源能被可靠地释放。


### 二、为什么 RAII 如此重要？

#### 传统 C 风格的问题（无 RAII）：

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">c</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span>FILE</span><span class="token">*</span><span> f </span><span class="token">=</span><span> </span><span class="token">fopen</span><span class="token">(</span><span class="token">"data.txt"</span><span class="token">,</span><span> </span><span class="token">"r"</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">// ... 读取文件</span><span>
</span><span></span><span class="token">// 忘记 fclose(f) → 资源泄漏！</span><span>
</span><span></span><span class="token">// 或中间 return / 出错 → fclose 可能跳过</span></code></pre></div></div></pre>

#### C++ RAII 风格（安全）：

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>ifstream </span><span class="token">file</span><span class="token">(</span><span class="token">"data.txt"</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 构造时打开文件（获取资源）</span><span>
</span><span>    </span><span class="token">// ... 读取</span><span>
</span><span></span><span class="token">}</span><span> </span><span class="token">// ← 离开作用域，file 自动析构 → fclose 被调用（释放资源）</span></code></pre></div></div></pre>

✅ 无论正常退出还是抛出异常，`file` 都会被正确关闭！

---

### 三、RAII 的典型应用


| 资源类型         | RAII 封装类                           | 说明              |
| ---------------- | ------------------------------------- | ----------------- |
| 动态内存         | `std::unique_ptr`, `std::vector`      | 自动 delete       |
| 文件             | `std::ifstream`, `std::ofstream`      | 自动 close        |
| 互斥锁           | `std::lock_guard`, `std::unique_lock` | 自动 unlock       |
| 网络 socket      | 自定义 RAII 类（如`SocketGuard`）     | 自动 close socket |
| OpenGL 纹理/缓冲 | 自定义智能资源类                      | 自动 glDelete     |



### 四、RAII 与智能指针的关系

智能指针（如 `std::unique_ptr`）是 RAII 在**动态内存管理**上的直接体现：

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">void</span><span> </span><span class="token">func</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">auto</span><span> ptr </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span class="token generic-function">make_unique</span><span class="token generic-function generic"><</span><span class="token generic-function generic">int</span><span class="token generic-function generic">></span><span class="token">(</span><span class="token">42</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 构造时 new（获取内存）</span><span>
</span><span>    </span><span class="token">// ... 使用</span><span>
</span><span></span><span class="token">}</span><span> </span><span class="token">// ← ptr 离开作用域 → 析构 → 自动 delete（释放内存）</span></code></pre></div></div></pre>

👉 这就是 Cherno 在第71课中强调“用智能指针代替原始指针”的根本原因：**智能指针是 RAII 的具体实现**。

---

### 五、RAII 的优势总结


| 优势           | 说明                               |
| -------------- | ---------------------------------- |
| ✅**自动释放** | 无需手动 cleanup，编译器保证       |
| ✅**异常安全** | 即使抛异常，析构仍执行             |
| ✅**代码简洁** | 无需写`delete`/`close`/`unlock`    |
| ✅**防止泄漏** | 资源与对象生命周期严格一致         |
| ✅**可组合性** | 多个 RAII 对象可嵌套使用，顺序析构 |



### 六、自定义 RAII 类示例：自动加锁

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><iostream></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><mutex></span><span>
</span>
<span></span><span class="token">class</span><span> </span><span class="token">SafePrinter</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>mutex</span><span class="token">&</span><span> mtx</span><span class="token">;</span><span>
</span><span></span><span class="token">public</span><span class="token">:</span><span>
</span><span>    </span><span class="token">SafePrinter</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>mutex</span><span class="token">&</span><span> m</span><span class="token">)</span><span> </span><span class="token">:</span><span> </span><span class="token">mtx</span><span class="token">(</span><span>m</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        mtx</span><span class="token">.</span><span class="token">lock</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>   </span><span class="token">// 获取资源（锁）</span><span>
</span><span>        std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Locked\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span><span>    </span><span class="token">~</span><span class="token">SafePrinter</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        mtx</span><span class="token">.</span><span class="token">unlock</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 释放资源（解锁）</span><span>
</span><span>        std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Unlocked\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span><span>
</span>
<span>std</span><span class="token double-colon">::</span><span>mutex g_mtx</span><span class="token">;</span><span>
</span>
<span></span><span class="token">void</span><span> </span><span class="token">printMessage</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    SafePrinter </span><span class="token">guard</span><span class="token">(</span><span>g_mtx</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// RAII 锁</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Hello from thread!\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">// 即使这里 throw 异常，guard 也会析构并解锁！</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

> 💡 实际中应直接用 `std::lock_guard<std::mutex> lock(mtx);`，它就是标准库提供的 RAII 锁。

---

### 七、一句话理解 RAII

> **“不要手动管理资源，而是让一个对象替你管——它生时拿资源，死时还资源。”**


## 和python的with类似


**C++ 的 RAII 和 Python 的 `with` 语句在核心思想上高度相似**，都是为了**自动管理资源、确保清理操作一定执行**，但它们的实现机制完全不同。

---

### ✅ 共同目标：**“获取资源 → 使用 → 自动释放”**


| 特性         | C++ (RAII)                             | Python (`with`)                        |
| ------------ | -------------------------------------- | -------------------------------------- |
| **目的**     | 确保资源（内存、文件、锁等）被正确释放 | 确保上下文资源（文件、锁等）被正确清理 |
| **触发时机** | 对象离开作用域时（析构函数）           | `with` 块结束时（调用 `__exit__`）     |
| **异常安全** | ✅ 是（即使抛异常也会析构）            | ✅ 是（即使出错也会调用`__exit__`）    |
| **典型用途** | 文件、内存、锁、网络连接等             | 文件、锁、数据库连接等                 |

---

### 🌰 对比示例：文件操作

#### Python (`with`)

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">python</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">with</span><span> </span><span class="token builtin">open</span><span class="token">(</span><span class="token">"data.txt"</span><span class="token">,</span><span> </span><span class="token">"r"</span><span class="token">)</span><span> </span><span class="token">as</span><span> f</span><span class="token">:</span><span>
</span><span>    content </span><span class="token">=</span><span> f</span><span class="token">.</span><span>read</span><span class="token">(</span><span class="token">)</span><span>
</span><span>    </span><span class="token"># 即使这里 raise Exception，文件也会自动关闭！</span><span>
</span><span></span><span class="token"># ← 出 with 块，f.__exit__() 被调用 → 文件关闭</span></code></pre></div></div></pre>

#### C++ (RAII)

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>ifstream </span><span class="token">f</span><span class="token">(</span><span class="token">"data.txt"</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// 构造时打开</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>string content</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span class="token">getline</span><span class="token">(</span><span>f</span><span class="token">,</span><span> content</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">// 即使这里 throw 异常，f 也会析构 → 文件关闭！</span><span>
</span><span></span><span class="token">}</span><span> </span><span class="token">// ← 离开作用域，f.~ifstream() 被调用 → 文件关闭</span></code></pre></div></div></pre>

👉 **效果几乎一样！** 都保证了“用完就关”，无需手动 `close()`。


### 实现机制对比


| 机制                 | C++ RAII                                 | Python`with`                               |
| -------------------- | ---------------------------------------- | ------------------------------------------ |
| **依赖语言特性**     | 析构函数（Destruction） + 作用域生命周期 | 上下文管理协议（Context Manager Protocol） |
| **关键方法**         | 类的`~ClassName()` 析构函数              | 对象的`__enter__()` 和 `__exit__()` 方法   |
| **何时触发清理**     | 编译器自动插入析构调用（栈展开）         | 解释器在`with` 块结束时显式调用 `__exit__` |
| **是否需要显式语法** | ❌ 不需要（只要对象是局部变量）          | ✅ 需要写`with`                            |

> 💡 换句话说：
>
> * **C++ 的 RAII 是“隐式的”**：只要你用 RAII 类型的对象，安全自动生效。
> * **Python 的 `with` 是“显式的”**：你必须主动用 `with` 才能获得自动清理
>


### 自定义上下文管理（类比）

#### Python：实现 `__enter__` / `__exit__`

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">python</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">class</span><span> </span><span class="token">MyLock</span><span class="token">:</span><span>
</span><span>    </span><span class="token">def</span><span> </span><span class="token">__enter__</span><span class="token">(</span><span>self</span><span class="token">)</span><span class="token">:</span><span>
</span><span>        </span><span class="token">print</span><span class="token">(</span><span class="token">"Acquiring lock"</span><span class="token">)</span><span>
</span><span>        </span><span class="token">return</span><span> self
</span><span>    </span><span class="token">def</span><span> </span><span class="token">__exit__</span><span class="token">(</span><span>self</span><span class="token">,</span><span> exc_type</span><span class="token">,</span><span> exc_val</span><span class="token">,</span><span> exc_tb</span><span class="token">)</span><span class="token">:</span><span>
</span><span>        </span><span class="token">print</span><span class="token">(</span><span class="token">"Releasing lock"</span><span class="token">)</span><span>
</span>
<span></span><span class="token">with</span><span> MyLock</span><span class="token">(</span><span class="token">)</span><span class="token">:</span><span>
</span><span>    </span><span class="token">print</span><span class="token">(</span><span class="token">"In critical section"</span><span class="token">)</span><span>
</span><span></span><span class="token"># 输出：</span><span>
</span><span></span><span class="token"># Acquiring lock</span><span>
</span><span></span><span class="token"># In critical section</span><span>
</span><span></span><span class="token"># Releasing lock</span></code></pre></div></div></pre>

#### C++：实现 RAII 类（析构函数）

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">class</span><span> </span><span class="token">MyLock</span><span> </span><span class="token">{</span><span>
</span><span></span><span class="token">public</span><span class="token">:</span><span>
</span><span>    </span><span class="token">MyLock</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span> std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Acquiring lock\n"</span><span class="token">;</span><span> </span><span class="token">}</span><span>
</span><span>    </span><span class="token">~</span><span class="token">MyLock</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span> std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Releasing lock\n"</span><span class="token">;</span><span> </span><span class="token">}</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span><span>
</span>
<span></span><span class="token">void</span><span> </span><span class="token">func</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    MyLock lock</span><span class="token">;</span><span> </span><span class="token">// 构造</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"In critical section\n"</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span> </span><span class="token">// ← 析构自动调用</span></code></pre></div></div></pre>


### 重要区别


| 方面         | C++ RAII                            | Python`with`                                                 |
| ------------ | ----------------------------------- | ------------------------------------------------------------ |
| **适用范围** | **所有资源**（包括内存！）          | 主要是外部资源（文件、锁等），**不管理内存**（Python 有 GC） |
| **性能**     | 零开销（编译期确定）                | 有轻微运行时开销（函数调用）                                 |
| **内存管理** | ✅ 直接解决内存泄漏（通过智能指针） | ❌ 不解决（靠垃圾回收，可能延迟释放）                        |

> 🔑 关键点：**RAII 是 C++ 内存安全的核心**，而 Python 的 `with` 主要用于非内存资源。

---

### ✅ 总结


| 说法                                 | 正确性                                                         |
| ------------------------------------ | -------------------------------------------------------------- |
| “RAII 和`with` 解决的是同一类问题” | ✅ **对！**（资源自动清理）                                    |
| “RAII 就是 C++ 版的`with`”         | ⚠️ **近似对，但不完全等价**（RAII 更底层、更广泛、更自动）   |
| “Python 有 RAII 吗？”              | ❌ **没有**。Python 依赖 GC + `with`，不是基于析构的确定性销毁 |

> 💬 所以你可以理解为： **Python 的 `with` 是 RAII 思想在具有垃圾回收语言中的一种模拟实现**，而 **C++ 的 RAII 是语言原生支持的、更强大、更通用的机制**。
>
