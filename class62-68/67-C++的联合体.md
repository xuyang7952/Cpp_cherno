# C++ è”åˆä½“ï¼ˆUnionsï¼‰è¯´æ˜ä¸æ€»ç»“


## ä¸€ã€ä»€ä¹ˆæ˜¯è”åˆä½“ï¼ˆUnionï¼‰ï¼Ÿ

**è”åˆä½“ï¼ˆ`union`ï¼‰** æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå…¶æ‰€æœ‰æˆå‘˜**å…±äº«åŒä¸€å—å†…å­˜ç©ºé—´**ã€‚
è¿™æ„å‘³ç€ï¼š

* è”åˆä½“çš„å¤§å°ç­‰äºå…¶**æœ€å¤§æˆå‘˜çš„å¤§å°**ï¼›
* åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæˆå‘˜æ˜¯â€œæœ‰æ•ˆâ€çš„ï¼›
* ä¿®æ”¹ä¸€ä¸ªæˆå‘˜ä¼š**è¦†ç›–å…¶ä»–æˆå‘˜çš„å€¼**ã€‚

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">union</span><span> Data </span><span class="token">{</span><span>
</span><span>    </span><span class="token">int</span><span> i</span><span class="token">;</span><span>
</span><span>    </span><span class="token">float</span><span> f</span><span class="token">;</span><span>
</span><span>    </span><span class="token">char</span><span> c</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span><span> </span><span class="token">// sizeof(Data) == max(sizeof(int), sizeof(float), sizeof(char)) == 4 (é€šå¸¸)</span></code></pre></div></div></pre>

> ğŸ’¡ è”åˆä½“å¸¸ç”¨äº**ç±»å‹åŒå…³ï¼ˆType Punningï¼‰** æˆ–**èŠ‚çœå†…å­˜**çš„åœºæ™¯ã€‚



## äºŒã€å…³é”®ç‰¹æ€§ä¸é™åˆ¶


| ç‰¹æ€§                        | è¯´æ˜                                                                          |
| --------------------------- | ----------------------------------------------------------------------------- |
| **å†…å­˜å…±äº«**                | æ‰€æœ‰æˆå‘˜ä»åŒä¸€åœ°å€å¼€å§‹                                                        |
| **æ— æ„é€ /ææ„ä¿è¯**         | C++98 è”åˆä½“ä¸èƒ½åŒ…å«é POD ç±»å‹ï¼ˆå¦‚`std::string`ï¼‰                            |
| **C++11 æ”¹è¿›**              | å…è®¸åŒ…å«å¸¦æ„é€ å‡½æ•°çš„ç±»ï¼Œä½†éœ€æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼ˆä½¿ç”¨ placement new / æ˜¾å¼ææ„ï¼‰ |
| **åŒ¿åè”åˆä½“**              | å¯ç›´æ¥è®¿é—®æˆå‘˜ï¼ˆæ— éœ€é€šè¿‡å˜é‡åï¼‰ï¼Œä½†ä¸èƒ½æœ‰æˆå‘˜å‡½æ•°                            |
| **ä¸èƒ½ç»§æ‰¿ / ä¸èƒ½æœ‰è™šå‡½æ•°** | è”åˆä½“ä¸æ˜¯å®Œæ•´çš„ç±»                                                            |


## ä¸‰ã€å…¸å‹ç”¨é€”

### 1. **ç±»å‹åŒå…³ï¼ˆType Punningï¼‰**

å°†åŒä¸€æ®µå†…å­˜æŒ‰ä¸åŒç±»å‹è§£é‡Šï¼ˆå¦‚ `float` â†” `int` çš„ä½è¡¨ç¤ºï¼‰ã€‚

### 2. **å¤šè§†å›¾æ•°æ®ç»“æ„**

ä¾‹å¦‚ï¼š`Vector4` åŒæ—¶å¯çœ‹ä½œä¸¤ä¸ª `Vector2`ï¼š

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">struct</span><span> </span><span class="token">Vector4</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">union</span><span> </span><span class="token">{</span><span>
</span><span>        </span><span class="token">struct</span><span> </span><span class="token">{</span><span> </span><span class="token">float</span><span> x</span><span class="token">,</span><span> y</span><span class="token">,</span><span> z</span><span class="token">,</span><span> w</span><span class="token">;</span><span> </span><span class="token">}</span><span class="token">;</span><span>
</span><span>        </span><span class="token">struct</span><span> </span><span class="token">{</span><span> Vector2 a</span><span class="token">,</span><span> b</span><span class="token">;</span><span> </span><span class="token">}</span><span class="token">;</span><span> </span><span class="token">// a = (x,y), b = (z,w)</span><span>
</span><span>    </span><span class="token">}</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span></code></pre></div></div></pre>

### 3. **èŠ‚çœå†…å­˜**

å½“å¤šä¸ªå˜é‡ä¸ä¼šåŒæ—¶ä½¿ç”¨æ—¶ï¼Œç”¨è”åˆä½“é¿å…å†—ä½™åˆ†é…ã€‚



## å››ã€é‡è¦è­¦å‘Š

* **è¯»å–æœªå†™å…¥çš„æˆå‘˜æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰ï¼**
* **ä¸è¦å¯¹é POD ç±»å‹ç›´æ¥ä½¿ç”¨è”åˆä½“**ï¼ˆé™¤éæ‰‹åŠ¨ç®¡ç†æ„é€ /ææ„ï¼‰
* **ç°ä»£ C++ ä¸­ï¼Œä¼˜å…ˆè€ƒè™‘ `std::variant`ï¼ˆå®‰å…¨ï¼‰æˆ– `std::bit_cast`ï¼ˆç±»å‹åŒå…³ï¼‰**



## äº”ã€å¯è¿è¡Œå®Œæ•´ä»£ç ç¤ºä¾‹

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><iostream></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><iomanip></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><cstring></span><span class="token macro"> </span><span class="token macro">// for memcpy</span><span>
</span>
<span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token">// 1. åŸºç¡€è”åˆä½“ï¼šç±»å‹åŒå…³</span><span>
</span><span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token">union</span><span> FloatInt </span><span class="token">{</span><span>
</span><span>    </span><span class="token">float</span><span> f</span><span class="token">;</span><span>
</span><span>    </span><span class="token">int</span><span> i</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span><span>
</span>
<span></span><span class="token">void</span><span> </span><span class="token">demo_basic_union</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"=== 1. åŸºç¡€è”åˆä½“ï¼šfloat/int ç±»å‹åŒå…³ ===\n"</span><span class="token">;</span><span>
</span><span>    FloatInt u</span><span class="token">;</span><span>
</span><span>    u</span><span class="token">.</span><span>f </span><span class="token">=</span><span> </span><span class="token">3.14159f</span><span class="token">;</span><span>
</span>
<span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"u.f = "</span><span> </span><span class="token"><<</span><span> u</span><span class="token">.</span><span>f </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"u.i (ä½è¡¨ç¤º) = 0x"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>hex </span><span class="token"><<</span><span> u</span><span class="token">.</span><span>i </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>dec </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">// éªŒè¯ï¼šç”¨ memcpy å®‰å…¨æ–¹å¼å¯¹æ¯”</span><span>
</span><span>    </span><span class="token">int</span><span> safe_bits</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span class="token">memcpy</span><span class="token">(</span><span class="token">&</span><span>safe_bits</span><span class="token">,</span><span> </span><span class="token">&</span><span>u</span><span class="token">.</span><span>f</span><span class="token">,</span><span> </span><span class="token">sizeof</span><span class="token">(</span><span>u</span><span class="token">.</span><span>f</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"memcpy æ–¹å¼: 0x"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>hex </span><span class="token"><<</span><span> safe_bits </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>dec </span><span class="token"><<</span><span> </span><span class="token">"\n\n"</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token">// 2. åŒ¿åè”åˆä½“ + åµŒå¥—ç»“æ„ä½“ï¼ˆCherno ç¤ºä¾‹ï¼‰</span><span>
</span><span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token">struct</span><span> </span><span class="token">Vector2</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">float</span><span> x</span><span class="token">,</span><span> y</span><span class="token">;</span><span>
</span><span>    </span><span class="token">friend</span><span> std</span><span class="token double-colon">::</span><span>ostream</span><span class="token">&</span><span> </span><span class="token">operator</span><span class="token"><<</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>ostream</span><span class="token">&</span><span> os</span><span class="token">,</span><span> </span><span class="token">const</span><span> Vector2</span><span class="token">&</span><span> v</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        </span><span class="token">return</span><span> os </span><span class="token"><<</span><span> </span><span class="token">"("</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>x </span><span class="token"><<</span><span> </span><span class="token">", "</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>y </span><span class="token"><<</span><span> </span><span class="token">")"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span><span>
</span>
<span></span><span class="token">struct</span><span> </span><span class="token">Vector4</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">union</span><span> </span><span class="token">{</span><span>
</span><span>        </span><span class="token">struct</span><span> </span><span class="token">{</span><span> </span><span class="token">float</span><span> x</span><span class="token">,</span><span> y</span><span class="token">,</span><span> z</span><span class="token">,</span><span> w</span><span class="token">;</span><span> </span><span class="token">}</span><span class="token">;</span><span>      </span><span class="token">// åŒ¿åç»“æ„ä½“1</span><span>
</span><span>        </span><span class="token">struct</span><span> </span><span class="token">{</span><span> Vector2 a</span><span class="token">,</span><span> b</span><span class="token">;</span><span> </span><span class="token">}</span><span class="token">;</span><span>          </span><span class="token">// åŒ¿åç»“æ„ä½“2ï¼ša=(x,y), b=(z,w)</span><span>
</span><span>    </span><span class="token">}</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">Vector4</span><span class="token">(</span><span class="token">float</span><span> x</span><span class="token">,</span><span> </span><span class="token">float</span><span> y</span><span class="token">,</span><span> </span><span class="token">float</span><span> z</span><span class="token">,</span><span> </span><span class="token">float</span><span> w</span><span class="token">)</span><span> </span><span class="token">:</span><span> </span><span class="token">x</span><span class="token">(</span><span>x</span><span class="token">)</span><span class="token">,</span><span> </span><span class="token">y</span><span class="token">(</span><span>y</span><span class="token">)</span><span class="token">,</span><span> </span><span class="token">z</span><span class="token">(</span><span>z</span><span class="token">)</span><span class="token">,</span><span> </span><span class="token">w</span><span class="token">(</span><span>w</span><span class="token">)</span><span> </span><span class="token">{</span><span class="token">}</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span><span>
</span>
<span></span><span class="token">void</span><span> </span><span class="token">demo_vector4_union</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"=== 2. Vector4 è”åˆä½“ï¼šå¤šè§†å›¾è®¿é—® ===\n"</span><span class="token">;</span><span>
</span><span>    Vector4 </span><span class="token">v</span><span class="token">(</span><span class="token">1.0f</span><span class="token">,</span><span> </span><span class="token">2.0f</span><span class="token">,</span><span> </span><span class="token">3.0f</span><span class="token">,</span><span> </span><span class="token">4.0f</span><span class="token">)</span><span class="token">;</span><span>
</span>
<span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"v.x, v.y, v.z, v.w = "</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>x </span><span class="token"><<</span><span> </span><span class="token">", "</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>y </span><span class="token"><<</span><span> </span><span class="token">", "</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>z </span><span class="token"><<</span><span> </span><span class="token">", "</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>w </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"v.a = "</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>a </span><span class="token"><<</span><span> </span><span class="token">", v.b = "</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>b </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">// ä¿®æ”¹ v.z ä¼šå½±å“ v.b.x</span><span>
</span><span>    v</span><span class="token">.</span><span>z </span><span class="token">=</span><span> </span><span class="token">500.0f</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"ä¿®æ”¹ v.z = 500 å:\n"</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"v.b = "</span><span> </span><span class="token"><<</span><span> v</span><span class="token">.</span><span>b </span><span class="token"><<</span><span> </span><span class="token">"  // æ³¨æ„ï¼šb.x å˜ä¸º 500\n\n"</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token">// 3. æ‰‹åŠ¨ç®¡ç†é POD ç±»å‹ï¼ˆC++11+ï¼‰</span><span>
</span><span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><string></span><span>
</span>
<span></span><span class="token">struct</span><span> </span><span class="token">StringOrInt</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">enum</span><span> </span><span class="token">Type</span><span> </span><span class="token">{</span><span> STRING</span><span class="token">,</span><span> INT </span><span class="token">}</span><span> type</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">union</span><span> </span><span class="token">{</span><span>
</span><span>        </span><span class="token">int</span><span> i</span><span class="token">;</span><span>
</span><span>        std</span><span class="token double-colon">::</span><span>string s</span><span class="token">;</span><span> </span><span class="token">// C++11 å…è®¸ï¼Œä½†éœ€æ‰‹åŠ¨ç®¡ç†</span><span>
</span><span>    </span><span class="token">}</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">// æ„é€ å‡½æ•°</span><span>
</span><span>    </span><span class="token">StringOrInt</span><span class="token">(</span><span class="token">int</span><span> value</span><span class="token">)</span><span> </span><span class="token">:</span><span> </span><span class="token">type</span><span class="token">(</span><span>INT</span><span class="token">)</span><span class="token">,</span><span> </span><span class="token">i</span><span class="token">(</span><span>value</span><span class="token">)</span><span> </span><span class="token">{</span><span class="token">}</span><span>
</span><span>    </span><span class="token">StringOrInt</span><span class="token">(</span><span class="token">const</span><span> </span><span class="token">char</span><span class="token">*</span><span> str</span><span class="token">)</span><span> </span><span class="token">:</span><span> </span><span class="token">type</span><span class="token">(</span><span>STRING</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        </span><span class="token">new</span><span class="token">(</span><span class="token">&</span><span>s</span><span class="token">)</span><span> std</span><span class="token double-colon">::</span><span class="token">string</span><span class="token">(</span><span>str</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// placement new</span><span>
</span><span>    </span><span class="token">}</span><span>
</span>
<span>    </span><span class="token">// ææ„å‡½æ•°ï¼ˆå¿…é¡»æ˜¾å¼è°ƒç”¨ string çš„ææ„ï¼‰</span><span>
</span><span>    </span><span class="token">~</span><span class="token">StringOrInt</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        </span><span class="token">if</span><span> </span><span class="token">(</span><span>type </span><span class="token">==</span><span> STRING</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>            s</span><span class="token">.</span><span class="token">~</span><span class="token">basic_string</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// æ˜¾å¼ææ„</span><span>
</span><span>        </span><span class="token">}</span><span>
</span><span>    </span><span class="token">}</span><span>
</span>
<span>    </span><span class="token">void</span><span> </span><span class="token">print</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">const</span><span> </span><span class="token">{</span><span>
</span><span>        </span><span class="token">if</span><span> </span><span class="token">(</span><span>type </span><span class="token">==</span><span> INT</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>            std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"int: "</span><span> </span><span class="token"><<</span><span> i</span><span class="token">;</span><span>
</span><span>        </span><span class="token">}</span><span> </span><span class="token">else</span><span> </span><span class="token">{</span><span>
</span><span>            std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"string: \""</span><span> </span><span class="token"><<</span><span> s </span><span class="token"><<</span><span> </span><span class="token">"\""</span><span class="token">;</span><span>
</span><span>        </span><span class="token">}</span><span>
</span><span>    </span><span class="token">}</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span><span>
</span>
<span></span><span class="token">void</span><span> </span><span class="token">demo_non_pod_union</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"=== 3. æ‰‹åŠ¨ç®¡ç†é POD è”åˆä½“ ===\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">{</span><span>
</span><span>        StringOrInt </span><span class="token">a</span><span class="token">(</span><span class="token">42</span><span class="token">)</span><span class="token">;</span><span>
</span><span>        StringOrInt </span><span class="token">b</span><span class="token">(</span><span class="token">"Hello Union!"</span><span class="token">)</span><span class="token">;</span><span>
</span>
<span>        a</span><span class="token">.</span><span class="token">print</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span><span>        b</span><span class="token">.</span><span class="token">print</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span> std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span> </span><span class="token">// ææ„å‡½æ•°è‡ªåŠ¨è°ƒç”¨ï¼Œå®‰å…¨é‡Šæ”¾</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token">// 4. å¯¹æ¯”ï¼šç°ä»£æ›¿ä»£æ–¹æ¡ˆ std::variantï¼ˆæ¨èï¼‰</span><span>
</span><span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><variant></span><span>
</span>
<span></span><span class="token">void</span><span> </span><span class="token">demo_std_variant</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"=== 4. ç°ä»£æ›¿ä»£ï¼šstd::variantï¼ˆå®‰å…¨ï¼ï¼‰===\n"</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>variant</span><span class="token"><</span><span class="token">int</span><span class="token">,</span><span> std</span><span class="token double-colon">::</span><span>string</span><span class="token">></span><span> v </span><span class="token">=</span><span> </span><span class="token">"Hello Variant!"</span><span class="token">;</span><span>
</span>  
<span>    </span><span class="token">if</span><span> </span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span class="token generic-function">holds_alternative</span><span class="token generic-function generic"><</span><span class="token generic-function generic">std</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">string</span><span class="token generic-function generic">></span><span class="token">(</span><span>v</span><span class="token">)</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Variant contains: "</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span class="token generic-function">get</span><span class="token generic-function generic"><</span><span class="token generic-function generic">std</span><span class="token generic-function generic double-colon">::</span><span class="token generic-function generic">string</span><span class="token generic-function generic">></span><span class="token">(</span><span>v</span><span class="token">)</span><span> </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span>
<span>    v </span><span class="token">=</span><span> </span><span class="token">100</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Now contains: "</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span class="token generic-function">get</span><span class="token generic-function generic"><</span><span class="token generic-function generic">int</span><span class="token generic-function generic">></span><span class="token">(</span><span>v</span><span class="token">)</span><span> </span><span class="token"><<</span><span> </span><span class="token">"\n\n"</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token">// ä¸»å‡½æ•°</span><span>
</span><span></span><span class="token">// ----------------------------</span><span>
</span><span></span><span class="token">int</span><span> </span><span class="token">main</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">demo_basic_union</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">demo_vector4_union</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">demo_non_pod_union</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">demo_std_variant</span><span class="token">(</span><span class="token">)</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">return</span><span> </span><span class="token">0</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>


## å…«ã€è”åˆä½“ vs ç°ä»£æ›¿ä»£æ–¹æ¡ˆ


| åœºæ™¯                    | æ¨èæ–¹æ¡ˆ                            |
| ----------------------- | ----------------------------------- |
| **ç±»å‹åŒå…³ï¼ˆä½æ“ä½œï¼‰**  | `std::bit_cast`ï¼ˆC++20ï¼‰æˆ– `memcpy` |
| **å¤šç±»å‹å­˜å‚¨ï¼ˆå®‰å…¨ï¼‰**  | `std::variant`ï¼ˆC++17ï¼‰             |
| **åº•å±‚å†…å­˜å¤ç”¨ï¼ˆPODï¼‰** | åŒ¿åè”åˆä½“ï¼ˆå¦‚`Vector4` ç¤ºä¾‹ï¼‰      |
| **é POD å¤šç±»å‹**       | é¿å…è”åˆä½“ï¼Œç”¨`std::variant`        |


## ä¹ã€æœ€ä½³å®è·µæ€»ç»“

1. **ä»…å¯¹ POD ç±»å‹ä½¿ç”¨ç®€å•è”åˆä½“**ï¼ˆå¦‚ `int`/`float`/ç»“æ„ä½“ï¼‰ï¼›
2. **æ°¸è¿œä¸è¦è¯»å–æœªå†™å…¥çš„æˆå‘˜**ï¼›
3. **C++11+ ä¸­è‹¥å¿…é¡»ç”¨é POD è”åˆä½“ï¼ŒåŠ¡å¿…æ‰‹åŠ¨ç®¡ç†æ„é€ /ææ„**ï¼›
4. **ä¼˜å…ˆè€ƒè™‘ `std::variant` â€”â€” å®ƒæ˜¯ç±»å‹å®‰å…¨çš„â€œç°ä»£è”åˆä½“â€**ï¼›
5. **ç±»å‹åŒå…³é¦–é€‰ `std::memcpy` æˆ– `std::bit_cast`ï¼Œè€Œéè”åˆä½“**ï¼ˆå› è”åˆä½“åœ¨ C++ ä¸­è¯»å–éæ´»è·ƒæˆå‘˜æ˜¯ UBï¼‰ï¼›

> ğŸš¨ **é‡è¦æé†’**ï¼šå°½ç®¡ GCC/Clang å…è®¸é€šè¿‡è”åˆä½“è¿›è¡Œç±»å‹åŒå…³ï¼ˆä½œä¸ºæ‰©å±•ï¼‰ï¼Œä½† **C++ æ ‡å‡†è§„å®šè¿™æ˜¯æœªå®šä¹‰è¡Œä¸º**ã€‚ç”Ÿäº§ä»£ç åº”é¿å…ä¾èµ–æ­¤è¡Œä¸ºã€‚


## åã€ä¸€å¥è¯æ€»ç»“

> **è”åˆä½“æ˜¯å¼ºå¤§çš„åº•å±‚å·¥å…·ï¼Œé€‚ç”¨äºå†…å­˜å¸ƒå±€æ§åˆ¶å’Œæ€§èƒ½æ•æ„Ÿåœºæ™¯ï¼Œä½†åœ¨ç°ä»£ C++ ä¸­ï¼Œåº”ä¼˜å…ˆé€‰æ‹©æ›´å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆå¦‚ `std::variant` å’Œ `std::bit_cast`ï¼‰ã€‚åªæœ‰åœ¨æ˜ç¡®éœ€è¦å†…å­˜é‡å ä¸”ç¡®ä¿ç±»å‹å®‰å…¨æ—¶ï¼Œæ‰è°¨æ…ä½¿ç”¨è”åˆä½“ã€‚**
>
