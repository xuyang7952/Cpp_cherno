# C++ ä¸­çš„ç±»å‹åŒå…³ï¼ˆType Punningï¼‰è¯´æ˜ä¸æ€»ç»“

## ä¸€ã€ä»€ä¹ˆæ˜¯â€œç±»å‹åŒå…³â€ï¼ˆType Punningï¼‰ï¼Ÿ

**Type punning** æ˜¯ä¸€ä¸ªæœ¯è¯­ï¼ŒæŒ‡åœ¨ C++ ä¸­**ç»•è¿‡ç±»å‹ç³»ç»Ÿ**ï¼Œå°†ä¸€æ®µå†…å­˜æŒ‰**ä¸åŒç±»å‹çš„è§†è§’**æ¥è§£é‡Šã€‚

ä¾‹å¦‚ï¼š

* æŠŠä¸€ä¸ª `float` çš„äºŒè¿›åˆ¶ä½å½“ä½œ `int` æ¥è¯»å–ï¼›
* æŠŠä¸€ä¸ªç»“æ„ä½“å½“ä½œå­—èŠ‚æ•°ç»„æ¥åºåˆ—åŒ–ã€‚

> ğŸ’¡ C++ æ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œä½†å…è®¸ç›´æ¥æ“ä½œå†…å­˜ï¼Œå› æ­¤å¯ä»¥â€œæ¬ºéª—â€ç±»å‹ç³»ç»Ÿ â€”â€” è¿™å°±æ˜¯ç±»å‹åŒå…³ã€‚

## äºŒã€ä¸ºä»€ä¹ˆéœ€è¦ç±»å‹åŒå…³ï¼Ÿ

å¸¸è§ç”¨é€”åŒ…æ‹¬ï¼š

* **ç½‘ç»œ/æ–‡ä»¶åºåˆ—åŒ–**ï¼ˆæŠŠå¯¹è±¡è½¬æˆå­—èŠ‚æµï¼‰
* **åº•å±‚ç¡¬ä»¶äº¤äº’**ï¼ˆå¦‚ GPUã€ä¼ æ„Ÿå™¨æ•°æ®ï¼‰
* **æ€§èƒ½ä¼˜åŒ–**ï¼ˆé¿å…æ‹·è´ï¼Œç›´æ¥ reinterpretï¼‰
* **å®ç°æ³›å‹å®¹å™¨æˆ–è°ƒè¯•å·¥å…·**

ä½†âš ï¸ **å®ƒç ´åäº†ç±»å‹å®‰å…¨**ï¼Œä½¿ç”¨ä¸å½“ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºï¼ˆUBï¼‰ï¼

## ä¸‰ã€é”™è¯¯æ–¹å¼ï¼šC é£æ ¼å¼ºåˆ¶è½¬æ¢ï¼ˆå±é™©ï¼ï¼‰

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">int</span><span> a </span><span class="token">=</span><span> </span><span class="token">0x41C80000</span><span class="token">;</span><span> </span><span class="token">// å®é™…æ˜¯ float 25.0 çš„ IEEE 754 è¡¨ç¤º</span><span>
</span><span></span><span class="token">float</span><span> f </span><span class="token">=</span><span> </span><span class="token">*</span><span class="token">(</span><span class="token">float</span><span class="token">*</span><span class="token">)</span><span class="token">&</span><span>a</span><span class="token">;</span><span> </span><span class="token">// ç±»å‹åŒå…³ï¼šæŠŠ int å†…å­˜å½“ float è§£é‡Š</span></code></pre></div></div></pre>

è™½ç„¶è¿™æ®µä»£ç åœ¨å¤§å¤šæ•°ç¼–è¯‘å™¨ä¸Šèƒ½è¿è¡Œï¼Œä½†å®ƒ**è¿åäº† C++ çš„ä¸¥æ ¼åˆ«åè§„åˆ™ï¼ˆStrict Aliasing Ruleï¼‰**ï¼Œå±äº**æœªå®šä¹‰è¡Œä¸ºï¼ˆUndefined Behaviorï¼‰**ï¼

> ğŸ”¥ ç¼–è¯‘å™¨å¯èƒ½ä¼˜åŒ–æ‰ä½ çš„ä»£ç ï¼Œæˆ–è€…ç¨‹åºåœ¨æŸäº›å¹³å°å´©æºƒã€‚

## å››ã€æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨ `std::bit_cast`ï¼ˆC++20 æ¨èï¼‰

C++20 å¼•å…¥äº†å®‰å…¨ã€æ ‡å‡†çš„ç±»å‹åŒå…³å·¥å…·ï¼š

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><bit></span><span>
</span><span></span><span class="token">float</span><span> f </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span class="token generic-function">bit_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">float</span><span class="token generic-function generic">></span><span class="token">(</span><span>a</span><span class="token">)</span><span class="token">;</span></code></pre></div></div></pre>

* **æ— æœªå®šä¹‰è¡Œä¸º**
* è¦æ±‚æºç±»å‹å’Œç›®æ ‡ç±»å‹å¤§å°ç›¸åŒ
* ç¼–è¯‘æœŸæ£€æŸ¥ï¼Œå®‰å…¨å¯é 

> âœ… è¿™æ˜¯ç°ä»£ C++ ä¸­**å”¯ä¸€æ¨èçš„ç±»å‹åŒå…³æ–¹å¼**ã€‚

## äº”ã€æ›¿ä»£æ–¹æ¡ˆï¼ˆC++17 åŠä»¥å‰ï¼‰

### æ–¹æ¡ˆ1ï¼šé€šè¿‡ `union`ï¼ˆæœ‰äº‰è®®ï¼Œéƒ¨åˆ†ç¼–è¯‘å™¨æ”¯æŒï¼‰

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">union</span><span> FloatInt </span><span class="token">{</span><span>
</span><span>    </span><span class="token">int</span><span> i</span><span class="token">;</span><span>
</span><span>    </span><span class="token">float</span><span> f</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span class="token">;</span><span>
</span>
<span>FloatInt u</span><span class="token">;</span><span>
</span><span>u</span><span class="token">.</span><span>i </span><span class="token">=</span><span> </span><span class="token">0x41C80000</span><span class="token">;</span><span>
</span><span>std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> u</span><span class="token">.</span><span>f</span><span class="token">;</span><span> </span><span class="token">// è¾“å‡º 25.0</span></code></pre></div></div></pre>

> âš ï¸ **æ³¨æ„**ï¼šC++ æ ‡å‡†è§„å®šï¼Œè¯»å–éæœ€åå†™å…¥çš„ union æˆå‘˜æ˜¯**æœªå®šä¹‰è¡Œä¸º**ï¼
> å°½ç®¡ GCC/Clang å…è®¸ï¼ˆä½œä¸ºæ‰©å±•ï¼‰ï¼Œä½†**ä¸å…·å¯ç§»æ¤æ€§**ï¼Œä¸æ¨èç”¨äºç”Ÿäº§ä»£ç ã€‚

---

### æ–¹æ¡ˆ2ï¼šé€šè¿‡ `memcpy`ï¼ˆå®‰å…¨ä¸”å¹¿æ³›å…¼å®¹ï¼‰

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token">int</span><span> a </span><span class="token">=</span><span> </span><span class="token">0x41C80000</span><span class="token">;</span><span>
</span><span></span><span class="token">float</span><span> f</span><span class="token">;</span><span>
</span><span>std</span><span class="token double-colon">::</span><span class="token">memcpy</span><span class="token">(</span><span class="token">&</span><span>f</span><span class="token">,</span><span> </span><span class="token">&</span><span>a</span><span class="token">,</span><span> </span><span class="token">sizeof</span><span class="token">(</span><span>f</span><span class="token">)</span><span class="token">)</span><span class="token">;</span></code></pre></div></div></pre>

* **å®Œå…¨ç¬¦åˆæ ‡å‡†**
* ç¼–è¯‘å™¨é€šå¸¸ä¼šä¼˜åŒ–ä¸ºç›´æ¥å¯„å­˜å™¨æ“ä½œï¼ˆæ— å®é™…å†…å­˜æ‹·è´ï¼‰
* C++98 åˆ° C++23 éƒ½å¯ç”¨

> âœ… è¿™æ˜¯ C++20 ä¹‹å‰**æœ€å®‰å…¨ã€æœ€ä¾¿æº**çš„ç±»å‹åŒå…³æ–¹æ³•ã€‚

## å…­ã€å¯è¿è¡Œå®Œæ•´ä»£ç ç¤ºä¾‹ï¼ˆå«å¤šç§æ–¹æ³•å¯¹æ¯”ï¼‰

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class="" data-spm-anchor-id="5176.28103460.0.i27.228c4fa5LO1oSx"><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><iostream></span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><cstring></span><span class="token macro">   </span><span class="token macro">// for memcpy</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><bit></span><span class="token macro">       </span><span class="token macro">// for std::bit_cast (C++20)</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">include</span><span class="token macro"> </span><span class="token macro"><iomanip></span><span>
</span>
<span></span><span class="token">// æ–¹æ³•1ï¼šå±é™©çš„ C é£æ ¼è½¬æ¢ï¼ˆä¸æ¨èï¼‰</span><span>
</span><span></span><span class="token">float</span><span> </span><span class="token">type_pun_dangerous</span><span class="token">(</span><span class="token">int</span><span> bits</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">return</span><span> </span><span class="token">*</span><span class="token">(</span><span class="token">float</span><span class="token">*</span><span class="token">)</span><span class="token">(</span><span class="token">&</span><span>bits</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">// UB! Strict aliasing violation</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// æ–¹æ³•2ï¼šä½¿ç”¨ memcpyï¼ˆå®‰å…¨ï¼Œå…¼å®¹æ—§æ ‡å‡†ï¼‰</span><span>
</span><span></span><span class="token">float</span><span> </span><span class="token">type_pun_memcpy</span><span class="token">(</span><span class="token">int</span><span> bits</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">float</span><span> result</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span class="token">memcpy</span><span class="token">(</span><span class="token">&</span><span>result</span><span class="token">,</span><span> </span><span class="token">&</span><span>bits</span><span class="token">,</span><span> </span><span class="token">sizeof</span><span class="token">(</span><span>result</span><span class="token">)</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    </span><span class="token">return</span><span> result</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">// æ–¹æ³•3ï¼šC++20 std::bit_castï¼ˆæ¨èï¼‰</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">ifdef</span><span class="token macro"> </span><span class="token macro expression">__cpp_lib_bit_cast</span><span>
</span><span></span><span class="token">float</span><span> </span><span class="token">type_pun_bitcast</span><span class="token">(</span><span class="token">int</span><span> bits</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">return</span><span> std</span><span class="token double-colon">::</span><span class="token generic-function">bit_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">float</span><span class="token generic-function generic">></span><span class="token">(</span><span>bits</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">endif</span><span>
</span>
<span></span><span class="token">// æ–¹æ³•4ï¼šUnionï¼ˆä¸æ ‡å‡†ï¼Œä»…ä½œæ¼”ç¤ºï¼‰</span><span>
</span><span></span><span class="token">float</span><span> </span><span class="token">type_pun_union</span><span class="token">(</span><span class="token">int</span><span> bits</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">union</span><span> </span><span class="token">{</span><span> </span><span class="token">int</span><span> i</span><span class="token">;</span><span> </span><span class="token">float</span><span> f</span><span class="token">;</span><span> </span><span class="token">}</span><span> converter</span><span class="token">;</span><span>
</span><span>    converter</span><span class="token">.</span><span>i </span><span class="token">=</span><span> bits</span><span class="token">;</span><span>
</span><span>    </span><span class="token">return</span><span> converter</span><span class="token">.</span><span>f</span><span class="token">;</span><span> </span><span class="token">// technically UB in C++, but works in practice</span><span>
</span><span></span><span class="token">}</span><span>
</span>
<span></span><span class="token">int</span><span> </span><span class="token">main</span><span class="token">(</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">// IEEE 754: float 25.0 çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸º 0x41C80000</span><span>
</span><span>    </span><span class="token">int</span><span> bits </span><span class="token">=</span><span> </span><span class="token">0x41C80000</span><span class="token">;</span><span>
</span>
<span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>fixed </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span class="token">setprecision</span><span class="token">(</span><span class="token">1</span><span class="token">)</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"åŸå§‹æ•´æ•° (åå…­è¿›åˆ¶): 0x"</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>hex </span><span class="token"><<</span><span> bits </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>dec </span><span class="token"><<</span><span> </span><span class="token">"\n\n"</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">// 1. å±é™©æ–¹å¼ï¼ˆå¯èƒ½è¢«ä¼˜åŒ–æ‰æˆ–å‡ºé”™ï¼‰</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"1. Cé£æ ¼è½¬æ¢ (å±é™©): "</span><span> </span><span class="token"><<</span><span> </span><span class="token">type_pun_dangerous</span><span class="token">(</span><span>bits</span><span class="token">)</span><span> </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">// 2. memcpyï¼ˆå®‰å…¨å¯é ï¼‰</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"2. memcpy (å®‰å…¨):     "</span><span> </span><span class="token"><<</span><span> </span><span class="token">type_pun_memcpy</span><span class="token">(</span><span>bits</span><span class="token">)</span><span> </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">// 3. std::bit_castï¼ˆC++20ï¼‰</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">ifdef</span><span class="token macro"> </span><span class="token macro expression">__cpp_lib_bit_cast</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"3. std::bit_cast (C++20): "</span><span> </span><span class="token"><<</span><span> </span><span class="token">type_pun_bitcast</span><span class="token">(</span><span>bits</span><span class="token">)</span><span> </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">else</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"3. std::bit_cast: ä¸å¯ç”¨ï¼ˆéœ€ C++20ï¼‰\n"</span><span class="token">;</span><span>
</span><span></span><span class="token macro directive-hash">#</span><span class="token macro">endif</span><span>
</span>
<span>    </span><span class="token">// 4. Unionï¼ˆéæ ‡å‡†ï¼‰</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"4. Union (éæ ‡å‡†):    "</span><span> </span><span class="token"><<</span><span> </span><span class="token">type_pun_union</span><span class="token">(</span><span>bits</span><span class="token">)</span><span> </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span>
<span>    </span><span class="token">// ==============================</span><span>
</span><span>    </span><span class="token">// å®é™…åº”ç”¨ï¼šç»“æ„ä½“åºåˆ—åŒ–ä¸ºå­—èŠ‚</span><span>
</span><span>    </span><span class="token">// ==============================</span><span>
</span><span>    </span><span class="token">struct</span><span> </span><span class="token">Entity</span><span> </span><span class="token">{</span><span>
</span><span>        </span><span class="token">int</span><span> x </span><span class="token">=</span><span> </span><span class="token">123</span><span class="token">;</span><span>
</span><span>        </span><span class="token">int</span><span> y </span><span class="token">=</span><span> </span><span class="token">456</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span class="token">;</span><span>
</span>
<span>    Entity e</span><span class="token">;</span><span>
</span><span>    </span><span class="token">unsigned</span><span> </span><span class="token">char</span><span class="token">*</span><span> bytes </span><span class="token">=</span><span> </span><span class="token generic-function">reinterpret_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">unsigned</span><span class="token generic-function generic"> </span><span class="token generic-function generic">char</span><span class="token generic-function generic">*</span><span class="token generic-function generic">></span><span class="token">(</span><span class="token">&</span><span>e</span><span class="token">)</span><span class="token">;</span><span>
</span>
<span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"\n=== ç»“æ„ä½“ç±»å‹åŒå…³ï¼šåºåˆ—åŒ–ä¸ºå­—èŠ‚ ===\n"</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Entity: ("</span><span> </span><span class="token"><<</span><span> e</span><span class="token">.</span><span>x </span><span class="token"><<</span><span> </span><span class="token">", "</span><span> </span><span class="token"><<</span><span> e</span><span class="token">.</span><span>y </span><span class="token"><<</span><span> </span><span class="token">")\n"</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"å‰8å­—èŠ‚ï¼ˆå°ç«¯åºï¼‰:\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">for</span><span> </span><span class="token">(</span><span>size_t i </span><span class="token">=</span><span> </span><span class="token">0</span><span class="token">;</span><span> i </span><span class="token"><</span><span> </span><span class="token">sizeof</span><span class="token">(</span><span>Entity</span><span class="token">)</span><span class="token">;</span><span> </span><span class="token">++</span><span>i</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>        std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"byte["</span><span> </span><span class="token"><<</span><span> i </span><span class="token"><<</span><span> </span><span class="token">"] = 0x"</span><span>
</span><span>                  </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>hex </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span class="token">setfill</span><span class="token">(</span><span class="token char">'0'</span><span class="token">)</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span class="token">setw</span><span class="token">(</span><span class="token">2</span><span class="token">)</span><span>
</span><span>                  </span><span class="token"><<</span><span> </span><span class="token generic-function">static_cast</span><span class="token generic-function generic"><</span><span class="token generic-function generic">int</span><span class="token generic-function generic">></span><span class="token">(</span><span>bytes</span><span class="token">[</span><span>i</span><span class="token">]</span><span class="token">)</span><span> </span><span class="token"><<</span><span> std</span><span class="token double-colon">::</span><span>dec </span><span class="token"><<</span><span> </span><span class="token">"\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">}</span><span>
</span>
<span>    </span><span class="token">// æ³¨æ„ï¼šè¿™ç§ reinterpret_cast ç”¨äº POD ç±»å‹æ˜¯å®‰å…¨çš„ï¼Œ</span><span>
</span><span>    </span><span class="token">// ä½†å‰ææ˜¯ç»“æ„ä½“æ²¡æœ‰è™šå‡½æ•°ã€ç»§æ‰¿ã€éå¹³å‡¡æ„é€ ç­‰ã€‚</span><span>
</span>
<span>    </span><span class="token">return</span><span> </span><span class="token">0</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

---

## ğŸ”§ ä¸ƒã€ç¼–è¯‘è¯´æ˜

### å¯¹äº C++20ï¼ˆå¯ç”¨ `std::bit_cast`ï¼‰ï¼š

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">bash</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span>g++ -std</span><span class="token">=</span><span>c++20 -O2 -o type_punning type_punning.cpp</span></code></pre></div></div></pre>

### å¯¹äºæ—§æ ‡å‡†ï¼ˆå¦‚ C++17ï¼‰ï¼š

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 text-[rgba(17,17,51,0.7)]">bash</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">ç¼–è¾‘</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-bRKDuR jCSJQZ"><code><span>g++ -std</span><span class="token">=</span><span>c++17 -O2 -o type_punning type_punning.cpp</span></code></pre></div></div></pre>



## ä¹ã€å…³é”®æ€»ç»“


| æ–¹æ³•            | å®‰å…¨æ€§          | æ ‡å‡†åˆè§„                | æ¨èåº¦                | é€‚ç”¨åœºæ™¯       |
| --------------- | --------------- | ----------------------- | --------------------- | -------------- |
| `*(T*)&x`       | âŒ å±é™©         | âŒ è¿å strict aliasing | â›” ç¦æ­¢               | ä»…ç”¨äºç†è§£åŸç† |
| `union`         | âš ï¸ ä¾èµ–ç¼–è¯‘å™¨ | âŒ C++ ä¸­æ˜¯ UB          | âš ï¸ é¿å…             | æ—§ä»£ç å…¼å®¹     |
| `std::memcpy`   | âœ… å®‰å…¨         | âœ… å®Œå…¨åˆè§„             | âœ…âœ… æ¨èï¼ˆC++20 å‰ï¼‰ | é€šç”¨ã€è·¨å¹³å°   |
| `std::bit_cast` | âœ… å®‰å…¨         | âœ… C++20 æ ‡å‡†           | âœ…âœ…âœ… é¦–é€‰           | ç°ä»£ C++ é¡¹ç›®  |


## åã€æœ€ä½³å®è·µå»ºè®®

1. **æ°¸è¿œä¸è¦ç”¨ `*(float*)&int_val` è¿™ç§æ–¹å¼** â€”â€” çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™åŸ‹é›·ã€‚
2. **C++20 èµ·ï¼Œä¼˜å…ˆä½¿ç”¨ `std::bit_cast<T>(value)`**ã€‚
3. **C++17 åŠä»¥å‰ï¼Œä½¿ç”¨ `std::memcpy`** â€”â€” å®‰å…¨ã€é«˜æ•ˆã€å¯ç§»æ¤ã€‚
4. **ç»“æ„ä½“ç±»å‹åŒå…³ä»…é€‚ç”¨äº PODï¼ˆPlain Old Dataï¼‰ç±»å‹**ï¼š
   * æ— è™šå‡½æ•°
   * æ— è‡ªå®šä¹‰æ„é€ /ææ„
   * æ— å¼•ç”¨æˆå‘˜
   * æ‰€æœ‰æˆå‘˜ä¹Ÿæ˜¯ POD


## æœ€åä¸€å¥è¯æ€»ç»“

> **â€œç±»å‹åŒå…³æ˜¯å¼ºå¤§çš„åº•å±‚å·¥å…·ï¼Œä½†å¿…é¡»ç”¨æ ‡å‡†è®¤å¯çš„æ–¹å¼ä½¿ç”¨ã€‚åœ¨ C++20 æ—¶ä»£ï¼Œè¯·æ‹¥æŠ± `std::bit_cast`ï¼›åœ¨æ­¤ä¹‹å‰ï¼Œè¯·ä¿¡èµ– `std::memcpy`ã€‚â€**
>
