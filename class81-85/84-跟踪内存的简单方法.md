# C++ 中跟踪内存分配的简单方法


## 核心思想

### 🔑 重载全局 `operator new` 和 `operator delete`

> **通过重载 C++ 的全局内存分配操作符，我们可以在每次 `new`/`delete` 调用时插入自定义逻辑，从而精确追踪内存分配的来源、大小和总量。**



## 为什么需要内存跟踪？

1. **性能优化**：减少不必要的堆分配
2. **内存泄漏检测**：监控分配/释放是否平衡
3. **调试辅助**：精确定位内存分配位置
4. **资源管理**：了解程序内存使用模式



## 代码关键点解析

### 1. **重载 `operator new`**

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-fhfEft edzoOS"><code><span class="token">void</span><span class="token">*</span><span> </span><span class="token">operator</span><span> </span><span class="token">new</span><span class="token">(</span><span>std</span><span class="token double-colon">::</span><span>size_t size</span><span class="token">)</span><span> </span><span class="token">{</span><span>
</span><span>    s_AllocationMetrics</span><span class="token">.</span><span>TotalAllocated </span><span class="token">+=</span><span> size</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Allocating "</span><span> </span><span class="token"><<</span><span> size </span><span class="token"><<</span><span> </span><span class="token">" bytes\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">return</span><span> </span><span class="token">malloc</span><span class="token">(</span><span>size</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

* 每次使用 `new` 时都会调用此函数
* 记录分配的字节数并输出日志
* 最终调用 `malloc` 进行实际内存分配

### 2. **重载 `operator delete`**

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-fhfEft edzoOS"><code><span class="token">void</span><span> </span><span class="token">operator</span><span> </span><span class="token">delete</span><span class="token">(</span><span class="token">void</span><span class="token">*</span><span> memory</span><span class="token">,</span><span> std</span><span class="token double-colon">::</span><span>size_t size</span><span class="token">)</span><span> </span><span class="token">noexcept</span><span> </span><span class="token">{</span><span>
</span><span>    s_AllocationMetrics</span><span class="token">.</span><span>TotalFreed </span><span class="token">+=</span><span> size</span><span class="token">;</span><span>
</span><span>    std</span><span class="token double-colon">::</span><span>cout </span><span class="token"><<</span><span> </span><span class="token">"Freeing "</span><span> </span><span class="token"><<</span><span> size </span><span class="token"><<</span><span> </span><span class="token">" bytes\n"</span><span class="token">;</span><span>
</span><span>    </span><span class="token">free</span><span class="token">(</span><span>memory</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

* C++17 开始，`delete` 可以接收大小参数
* 确保分配和释放的统计匹配

### 3. **兼容性处理**

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-fhfEft edzoOS"><code><span class="token">void</span><span> </span><span class="token">operator</span><span> </span><span class="token">delete</span><span class="token">(</span><span class="token">void</span><span class="token">*</span><span> memory</span><span class="token">)</span><span> </span><span class="token">noexcept</span><span> </span><span class="token">{</span><span>
</span><span>    </span><span class="token">free</span><span class="token">(</span><span>memory</span><span class="token">)</span><span class="token">;</span><span>
</span><span></span><span class="token">}</span></code></pre></div></div></pre>

* 处理没有大小信息的 `delete` 调用
* 保证与旧标准和某些编译器的兼容性

### 4. **智能指针支持**

<pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-fhfEft edzoOS"><code><span class="token">auto</span><span> obj2 </span><span class="token">=</span><span> std</span><span class="token double-colon">::</span><span class="token generic-function">make_unique</span><span class="token generic-function generic"><</span><span class="token generic-function generic">Object</span><span class="token generic-function generic">></span><span class="token">(</span><span class="token">4</span><span class="token">,</span><span> </span><span class="token">5</span><span class="token">,</span><span> </span><span class="token">6</span><span class="token">)</span><span class="token">;</span></code></pre></div></div></pre>

* `std::make_unique` 内部使用 `new`，所以会被我们的重载捕获
* 自动管理生命周期，确保正确调用 `delete`




## 最佳实践总结

### ✅ 推荐做法

1. **仅在调试版本中启用**：通过预处理器宏控制
   <pre><div class="contain-layout-style rounded-12 bg-capsule relative flex min-h-[2em] flex-col"><div class="rounded-[12px] bg-[#fff]"><div class="h-[36px] sticky top-0 z-10 bg-primary"><div class="flex items-center h-[36px] px-3 text-12 align-middle border border-[var(--ty-line-border)]"><span class="font-medium mr-auto first-letter:uppercase text-12 overflow-ellipsis whitespace-nowrap overflow-hidden text-[rgba(17,17,51,0.7)]">cpp</span><div class="flex items-center gap-4"><div class="flex items-center justify-center gap-[2px] cursor-pointer text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4 cursor-pointer"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-editingTools-line"></use></svg></span><span class="mt-[2px] text-[12px]">编辑</span></div><span role="img" tabindex="-1" class="anticon flex cursor-pointer items-center text-16 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-copy-line"></use></svg></span><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-moon-line"></use></svg></span></div><div class="flex cursor-pointer gap-1 text-[rgba(17,17,51,0.7)] hover:text-[#4433ff]"><span role="img" class="anticon text-16 size-4"><svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#pcicon-up-line"></use></svg></span></div></div></div></div><pre class="sc-fhfEft edzoOS"><code><span class="token macro directive-hash">#</span><span class="token macro">ifdef</span><span class="token macro"> </span><span class="token macro expression">DEBUG_MEMORY_TRACKING</span><span>
   </span><span></span><span class="token">// 重载 operator new/delete</span><span>
   </span><span></span><span class="token macro directive-hash">#</span><span class="token macro">endif</span></code></pre></div></div></pre>
2. **结合现有工具使用**：作为 Valgrind、AddressSanitizer 的补充
3. **记录分配位置**：在大型项目中记录文件名和行号
4. **性能监控**：定期检查内存使用趋势

### ❌ 避免的做法

1. **在生产代码中长期启用**：会影响性能
2. **忽略多线程安全**：在并发环境中会导致数据竞争
3. **过度依赖此方法**：仍需使用专业的内存分析工具



## 总结

Cherno 展示的这种内存跟踪方法具有以下优势：


| 优势         | 说明                         |
| ------------ | ---------------------------- |
| **简单易用** | 只需重载两个函数             |
| **零依赖**   | 不需要外部库或工具           |
| **精确控制** | 可以自定义统计逻辑和输出格式 |
| **快速集成** | 几分钟就能添加到现有项目中   |

> **记住**：这种方法主要用于**开发和调试阶段**，帮助你理解程序的内存行为。对于生产环境的内存问题，仍然建议使用专业的工具如 **Valgrind**（Linux）、**AddressSanitizer** 或 **Visual Studio Diagnostic Tools**。
>
